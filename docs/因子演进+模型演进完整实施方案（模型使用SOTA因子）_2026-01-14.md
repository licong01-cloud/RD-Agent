# 因子演进+模型演进完整实施方案（模型使用SOTA因子）

## 实施日期
2026-01-14

## 1. 需求分析

### 1.1 任务要求

**第一个任务：因子演进**
- 执行10个loop的因子演进
- 生成SOTA因子

**第二个任务：模型演进**
- 执行10个loop的模型演进
- 使用第一个任务的SOTA因子作为基础
- 训练和回测使用第一轮的SOTA因子和alpha22因子
- 更换不同的模型和参数进行演进

### 1.2 技术挑战

**问题1：如何从因子演进的结果继续执行模型演进？**
- `fin_factor` 和 `fin_model` 是独立的命令
- `fin_model` 无法直接访问 `fin_factor` 的workspace
- 需要修改代码才能实现从workspace加载SOTA因子

**问题2：如何确保模型演进使用SOTA因子？**
- 需要将因子演进的SOTA因子加载到 `based_experiments`
- 需要配置环境变量控制Alpha因子的使用

## 2. 解决方案

### 2.1 方案概述

根据代码分析，`model_runner.py` 已经有了从 `based_experiments` 加载SOTA因子的逻辑（第155-201行）。

**关键发现：**
- 代码已经支持从 `based_experiments` 加载SOTA因子
- 代码已经支持叠加Alpha因子（通过环境变量 `USE_ALPHA_FACTORS`）
- 只需要修改代码，支持从workspace加载SOTA因子到 `based_experiments`

### 2.2 修改代码方案

#### 步骤1：修改 `model_runner.py`

在 `@/f:/Dev/RD-Agent-main/rdagent/scenarios/qlib/developer/model_runner.py` 的 `develop` 方法开头添加从workspace加载SOTA因子的逻辑：

```python
@cache_with_pickle(qlib_model_cache_key, CachedRunner.assign_cached_result)
def develop(self, exp: QlibModelExperiment) -> QlibModelExperiment:
    # ===== 新增：从workspace加载SOTA因子 =====
    load_sota_from_workspace = os.getenv("LOAD_SOTA_FROM_WORKSPACE", "false") == "true"
    if load_sota_from_workspace:
        sota_workspace_path = Path(os.getenv("SOTA_WORKSPACE_PATH", ""))
        if sota_workspace_path.exists():
            sota_factors_path = sota_workspace_path / "combined_factors_df.parquet"
            if sota_factors_path.exists():
                try:
                    SOTA_factor = pd.read_parquet(sota_factors_path, engine="pyarrow")
                    logger.info(f"SOTA factors loaded from workspace: {sota_factors_path}")
                    logger.info(f"SOTA factors shape: {SOTA_factor.shape}")
                    
                    # 创建based_experiments
                    if not hasattr(exp, 'based_experiments') or exp.based_experiments is None:
                        exp.based_experiments = []
                    
                    # 创建一个虚拟的QlibFactorExperiment
                    sota_factor_exp = QlibFactorExperiment(sub_tasks=[])
                    sota_factor_exp.result = {
                        "IC": 0.0,  # 可以根据实际情况设置
                        "ICIR": 0.0,
                        "RankIC": 0.0,
                        "RankICIR": 0.0,
                    }
                    exp.based_experiments.append(sota_factor_exp)
                    logger.info(f"SOTA factor experiment added to based_experiments")
                except Exception as e:
                    logger.error(f"Failed to load SOTA factors from workspace: {e}")
            else:
                logger.warning(f"SOTA factors file not found: {sota_factors_path}")
        else:
            logger.warning(f"SOTA workspace path not found: {sota_workspace_path}")
    # ===== 新增结束 =====

    # 原有代码继续...
    if exp.based_experiments and exp.based_experiments[-1].result is None:
        exp.based_experiments[-1] = self.develop(exp.based_experiments[-1])

    exist_sota_factor_exp = False
    if exp.based_experiments:
        # ... 原有代码继续 ...
```

#### 步骤2：修改位置

在 `model_runner.py` 的第151行之后，第152行之前插入上述代码。

**修改前：**
```python
@cache_with_pickle(qlib_model_cache_key, CachedRunner.assign_cached_result)
def develop(self, exp: QlibModelExperiment) -> QlibModelExperiment:
    if exp.based_experiments and exp.based_experiments[-1].result is None:
        exp.based_experiments[-1] = self.develop(exp.based_experiments[-1])
    # ... 原有代码 ...
```

**修改后：**
```python
@cache_with_pickle(qlib_model_cache_key, CachedRunner.assign_cached_result)
def develop(self, exp: QlibModelExperiment) -> QlibModelExperiment:
    # ===== 新增：从workspace加载SOTA因子 =====
    load_sota_from_workspace = os.getenv("LOAD_SOTA_FROM_WORKSPACE", "false") == "true"
    if load_sota_from_workspace:
        sota_workspace_path = Path(os.getenv("SOTA_WORKSPACE_PATH", ""))
        if sota_workspace_path.exists():
            sota_factors_path = sota_workspace_path / "combined_factors_df.parquet"
            if sota_factors_path.exists():
                try:
                    SOTA_factor = pd.read_parquet(sota_factors_path, engine="pyarrow")
                    logger.info(f"SOTA factors loaded from workspace: {sota_factors_path}")
                    logger.info(f"SOTA factors shape: {SOTA_factor.shape}")
                    
                    # 创建based_experiments
                    if not hasattr(exp, 'based_experiments') or exp.based_experiments is None:
                        exp.based_experiments = []
                    
                    # 创建一个虚拟的QlibFactorExperiment
                    sota_factor_exp = QlibFactorExperiment(sub_tasks=[])
                    sota_factor_exp.result = {
                        "IC": 0.0,  # 可以根据实际情况设置
                        "ICIR": 0.0,
                        "RankIC": 0.0,
                        "RankICIR": 0.0,
                    }
                    exp.based_experiments.append(sota_factor_exp)
                    logger.info(f"SOTA factor experiment added to based_experiments")
                except Exception as e:
                    logger.error(f"Failed to load SOTA factors from workspace: {e}")
            else:
                logger.warning(f"SOTA factors file not found: {sota_factors_path}")
        else:
            logger.warning(f"SOTA workspace path not found: {sota_workspace_path}")
    # ===== 新增结束 =====

    if exp.based_experiments and exp.based_experiments[-1].result is None:
        exp.based_experiments[-1] = self.develop(exp.based_experiments[-1])
    # ... 原有代码继续 ...
```

### 2.3 环境变量配置

#### 步骤1：创建 `.env` 文件

在项目根目录创建或修改 `.env` 文件：

```bash
# 第一个任务：因子演进
LOAD_SOTA_FROM_WORKSPACE=false

# 第二个任务：模型演进
LOAD_SOTA_FROM_WORKSPACE=true
SOTA_WORKSPACE_PATH=./git_ignore_folder/RD-Agent_workspace/<factor_workspace_uuid>
USE_ALPHA_FACTORS=true
```

#### 步骤2：Alpha因子配置

Alpha因子配置文件位于：
`@/f:/Dev/RD-Agent-main/rdagent/scenarios/qlib/experiment/model_template/conf_baseline_factors_model.yaml`

确保该文件包含alpha22因子列表。

## 3. 完整执行步骤

### 3.1 第一个任务：执行10个Loop因子演进

#### 步骤1：准备环境

```bash
# 激活conda环境
conda activate rdagent

# 检查环境变量
cat .env
```

#### 步骤2：执行因子演进

```bash
# 执行10个loop的因子演进
rdagent fin_factor --loop_n 10
```

#### 步骤3：记录workspace路径

```bash
# 查看最新的workspace
ls -lt git_ignore_folder/RD-Agent_workspace/ | head -n 2

# 记录workspace路径，例如：
# git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea
```

#### 步骤4：验证SOTA因子

```bash
# 查看workspace中的SOTA因子文件
ls -la git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea/combined_factors_df.parquet

# 使用Python查看因子数量
python -c "
import pandas as pd
df = pd.read_parquet('git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea/combined_factors_df.parquet', engine='pyarrow')
print(f'SOTA因子数量: {len(df.columns)}')
print(f'SOTA因子列名: {df.columns.tolist()[:5]}...')
"
```

### 3.2 第二个任务：执行10个Loop模型演进（使用SOTA因子）

#### 步骤1：修改代码

按照2.2节的说明修改 `model_runner.py` 文件。

#### 步骤2：配置环境变量

修改 `.env` 文件：

```bash
# 设置环境变量
export LOAD_SOTA_FROM_WORKSPACE=true
export SOTA_WORKSPACE_PATH=./git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea
export USE_ALPHA_FACTORS=true
```

或者在 `.env` 文件中添加：

```env
LOAD_SOTA_FROM_WORKSPACE=true
SOTA_WORKSPACE_PATH=./git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea
USE_ALPHA_FACTORS=true
```

#### 步骤3：执行模型演进

```bash
# 执行10个loop的模型演进
rdagent fin_model --loop_n 10
```

#### 步骤4：监控执行

```bash
# 在另一个终端启动UI监控
rdagent ui --port 19899 --log-dir log/

# 或查看日志
tail -f log/latest.log
```

#### 步骤5：验证SOTA因子加载

查看日志中是否包含以下信息：

```
SOTA factors loaded from workspace: ./git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea/combined_factors_df.parquet
SOTA factors shape: (xxx, yyy)
SOTA factor experiment added to based_experiments
SOTA factor processing ...
叠加Alpha因子: 22个
```

## 4. 执行脚本

### 4.1 完整执行脚本

创建一个执行脚本 `run_factor_then_model.sh`：

```bash
#!/bin/bash

# ===== 第一个任务：因子演进 =====
echo "=========================================="
echo "开始执行第一个任务：10个Loop因子演进"
echo "=========================================="

# 设置环境变量
export LOAD_SOTA_FROM_WORKSPACE=false

# 执行因子演进
rdagent fin_factor --loop_n 10

# 获取最新的workspace路径
LATEST_WORKSPACE=$(ls -t git_ignore_folder/RD-Agent_workspace/ | head -n 1)
echo "最新的workspace: $LATEST_WORKSPACE"

# 验证SOTA因子
python -c "
import pandas as pd
df = pd.read_parquet(f'git_ignore_folder/RD-Agent_workspace/{LATEST_WORKSPACE}/combined_factors_df.parquet', engine='pyarrow')
print(f'SOTA因子数量: {len(df.columns)}')
print(f'SOTA因子形状: {df.shape}')
"

# ===== 第二个任务：模型演进 =====
echo "=========================================="
echo "开始执行第二个任务：10个Loop模型演进"
echo "=========================================="

# 设置环境变量
export LOAD_SOTA_FROM_WORKSPACE=true
export SOTA_WORKSPACE_PATH=./git_ignore_folder/RD-Agent_workspace/$LATEST_WORKSPACE
export USE_ALPHA_FACTORS=true

# 执行模型演进
rdagent fin_model --loop_n 10

echo "=========================================="
echo "所有任务执行完成"
echo "=========================================="
```

### 4.2 使用脚本

```bash
# 赋予执行权限
chmod +x run_factor_then_model.sh

# 执行脚本
./run_factor_then_model.sh
```

## 5. 执行时间估计

### 5.1 第一个任务：因子演进

- **单个loop时间**：30-60分钟
- **10个loop总时间**：5-10小时

### 5.2 第二个任务：模型演进

- **单个loop时间**：20-40分钟
- **10个loop总时间**：3.3-6.7小时

### 5.3 总时间

- **总时间**：8.3-16.7小时

## 6. 验证步骤

### 6.1 验证SOTA因子加载

**查看日志：**
```bash
grep "SOTA factors loaded from workspace" log/latest.log
grep "SOTA factor experiment added to based_experiments" log/latest.log
grep "叠加Alpha因子" log/latest.log
```

**查看因子数量：**
```bash
python -c "
import pandas as pd
df = pd.read_parquet('git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea/combined_factors_df.parquet', engine='pyarrow')
print(f'SOTA因子数量: {len(df.columns)}')
print(f'数据行数: {len(df)}')
"
```

### 6.2 验证模型性能

**查看模型IC：**
```bash
grep "IC" log/latest.log | tail -n 10
```

**查看模型结果：**
```bash
ls -la git_ignore_folder/RD-Agent_workspace/
```

## 7. 常见问题

### 7.1 如何找到正确的workspace路径？

```bash
# 查看所有workspace
ls -la git_ignore_folder/RD-Agent_workspace/

# 查看最新的workspace
ls -lt git_ignore_folder/RD-Agent_workspace/ | head -n 2

# 查看workspace中的文件
ls -la git_ignore_folder/RD-Agent_workspace/<workspace_uuid>/
```

### 7.2 如何验证SOTA因子是否正确加载？

**方法1：查看日志**
```bash
grep "SOTA factors loaded from workspace" log/latest.log
grep "SOTA factor experiment added to based_experiments" log/latest.log
```

**方法2：查看因子数量**
```bash
python -c "
import pandas as pd
df = pd.read_parquet('git_ignore_folder/RD-Agent_workspace/<workspace_uuid>/combined_factors_df.parquet', engine='pyarrow')
print(f'SOTA因子数量: {len(df.columns)}')
"
```

### 7.3 如何验证Alpha因子是否正确叠加？

**查看日志：**
```bash
grep "叠加Alpha因子" log/latest.log
```

**查看因子数量：**
```bash
python -c "
import pandas as pd
df = pd.read_parquet('git_ignore_folder/RD-Agent_workspace/<workspace_uuid>/combined_factors_df.parquet', engine='pyarrow')
print(f'总因子数量: {len(df.columns)}')
"
```

### 7.4 如果SOTA因子加载失败怎么办？

**检查环境变量：**
```bash
echo $LOAD_SOTA_FROM_WORKSPACE
echo $SOTA_WORKSPACE_PATH
```

**检查workspace路径：**
```bash
ls -la $SOTA_WORKSPACE_PATH/combined_factors_df.parquet
```

**查看错误日志：**
```bash
grep "Failed to load SOTA factors" log/latest.log
```

## 8. 高级配置

### 8.1 使用不同的模型

修改 `.env` 文件或环境变量：

```bash
# 使用不同的模型
export CHAT_MODEL=gpt-4-turbo
```

### 8.2 调整并行度

```bash
# 设置并行度
export MAX_PARALLEL=2
```

### 8.3 设置时间限制

```bash
# 设置最大执行时间
rdagent fin_model --loop_n 10 --all_duration "12h"
```

### 8.4 从session继续执行

```bash
# 如果中断，可以从session继续
rdagent fin_model $LOG_PATH/__session__ --loop_n 5
```

## 9. 回滚方法

### 9.1 回滚环境变量

```bash
# 回滚到原始行为
export LOAD_SOTA_FROM_WORKSPACE=false
```

### 9.2 回滚代码修改

如果需要回滚代码修改，可以使用git：

```bash
# 查看修改
git diff rdagent/scenarios/qlib/developer/model_runner.py

# 回滚修改
git checkout rdagent/scenarios/qlib/developer/model_runner.py
```

## 10. 总结

### 10.1 核心步骤

1. **修改代码**：在 `model_runner.py` 中添加从workspace加载SOTA因子的逻辑
2. **执行因子演进**：`rdagent fin_factor --loop_n 10`
3. **记录workspace路径**：保存因子演进的workspace路径
4. **配置环境变量**：设置 `LOAD_SOTA_FROM_WORKSPACE=true` 和 `SOTA_WORKSPACE_PATH`
5. **执行模型演进**：`rdagent fin_model --loop_n 10`

### 10.2 预期效果

- ✅ 第一个任务生成SOTA因子
- ✅ 第二个任务使用SOTA因子作为基础
- ✅ 模型演进使用SOTA因子和Alpha22因子
- ✅ 模型演进更换不同的模型和参数

### 10.3 注意事项

- ✅ 确保代码修改正确
- ✅ 确保环境变量配置正确
- ✅ 确保workspace路径正确
- ✅ 监控执行进度，及时处理错误

## 11. 附录

### 11.1 相关文档

- 从Workspace恢复任务执行方案分析_2026-01-14.md
- RD-Agent任务启动命令和参数分析报告_2026-01-14.md
- 执行10个Loop因子演进和10个Loop模型演进的具体步骤_2026-01-14.md

### 11.2 相关代码文件

- `@/f:/Dev/RD-Agent-main/rdagent/scenarios/qlib/developer/model_runner.py`
- `@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/factor.py`
- `@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/model.py`

### 11.3 版本历史

| 版本 | 日期 | 说明 |
|-----|------|------|
| v1.0 | 2026-01-14 | 初始版本，提供因子演进+模型演进完整实施方案，模型使用SOTA因子 |
