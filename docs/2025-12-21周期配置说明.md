# 2025-12-21 周期配置说明（训练/验证/测试/回测）

本文档说明 RD-Agent（Qlib 场景）中“训练/验证/测试/回测周期”的**实际生效来源**：哪些配置文件控制、哪些运行时参数可覆盖、以及提示词（prompt）与配置文件的关系。

## 结论（优先级）

- **实际生效（qrun 真正使用）**：以各个 Qlib 配置模板（`conf_*.yaml`）中的时间字段为准。
- **提示词（prompt）**：主要用于 UI 展示/给 LLM 提示实验设定，不会自动改写 `conf_*.yaml`（除非未来增加显式解析与写回逻辑）。因此 prompt 必须与配置模板一致，避免“显示/意图”和“实际运行”不一致。

## 一、由哪些配置文件控制周期（核心）

### 1) 因子实验（Factor）相关模板

目录：`rdagent/scenarios/qlib/experiment/factor_template/`

- **`conf_baseline.yaml`**
  - **全样本可用数据范围**：`data_handler_config.start_time` / `data_handler_config.end_time`
  - **归一化拟合窗口**：`fit_start_time` / `fit_end_time`（用于部分 Processor 的拟合区间）
  - **训练/验证/测试切分**：`task.dataset.kwargs.segments.train/valid/test`
  - **回测区间**：`port_analysis_config.backtest.start_time/end_time`

- **`conf_combined_factors.yaml`**（Alpha158 + 静态合并表）
  - 同样由 `data_handler_config.*`、`segments.*`、`backtest.*` 控制

- **`conf_combined_factors_dynamic.yaml`**（Alpha158 + 本轮生成因子 parquet）
  - 同样由 `data_handler_config.*`、`segments.*`、`backtest.*` 控制

- **`conf_combined_factors_sota_model.yaml`**（本轮生成因子 parquet + SOTA/现有模型）
  - 同样由 `data_handler_config.*`、`segments.*`、`backtest.*` 控制
  - 额外支持 `step_len`（见下文“参数覆盖”）

> 备注：`*_20251209_backup.yaml` 等 backup 文件通常是占位或历史备份，是否生效取决于 runner 是否会引用它们（当前主流程不会主动选择这些 backup 文件）。

### 2) 模型实验（Model）相关模板

目录：`rdagent/scenarios/qlib/experiment/model_template/`

- **`conf_baseline_factors_model.yaml`**
  - **全样本可用数据范围**：`data_handler_config.start_time/end_time`
  - **归一化拟合窗口**：`fit_start_time/fit_end_time`
  - **训练/验证/测试切分**：`segments.train/valid/test`
  - **回测区间**：`port_analysis_config.backtest.start_time/end_time`
  - **运行时可注入参数**：`dataset_cls`、`step_len`、`num_timesteps`、以及训练超参（见下文）

- **`conf_sota_factors_model.yaml`**
  - 结构与 baseline 类似，但 handler/data_loader 可能不同（包含 `NestedDataLoader` + `StaticDataLoader`）
  - 同样以 `segments.*`、`backtest.*` 为周期生效来源

- **`conf_baseline_factors_model_standalone.yaml`**
  - Tabular baseline（LGBModel）的 standalone 版本
  - 同样以 `segments.*`、`backtest.*` 为周期生效来源

> 备注：`*.backup_20251205.yaml`、`*_20251209_backup.yaml` 等属于历史备份，是否生效取决于 runner 选择。

## 二、哪些“参数”会影响周期/训练验证方式（覆盖机制）

这里区分两类：

### 1) 直接控制训练/验证/测试/回测“日期范围”的参数

在当前代码中，未发现通过 CLI/ENV 直接覆盖 `segments.train/valid/test` 或 `backtest.start_time/end_time` 的统一参数入口。

也就是说：**日期范围主要靠 `conf_*.yaml` 固定配置**。

### 2) 间接影响训练/验证方式的运行时参数（但不改日期）

- **模型侧 TimeSeries 数据集形态/窗口**（影响样本构造方式，而非日期）：
  - 来源：`rdagent/scenarios/qlib/developer/model_runner.py`
  - runner 会在调用 `qrun` 前注入环境变量（传入 `QlibFBWorkspace.execute(..., run_env=...)`），由 YAML Jinja 模板读取：
    - `dataset_cls`: `TSDatasetH` / `DatasetH`
    - `step_len`: 例如 20 / 60
    - `num_timesteps`: 例如 20 / 60

- **训练超参数（影响训练过程，不改日期）**：
  - 同样来自 `model_runner.py` 注入（`n_epochs/lr/early_stop/batch_size/weight_decay`）
  - YAML 模板（如 `conf_baseline_factors_model.yaml`、`conf_sota_factors_model.yaml`）使用 `{{ n_epochs }}` 等变量渲染。

- **缓存开关（不改日期）**：
  - `QLIB_QUANT_DISABLE_CACHE=1` 会关闭 runner 缓存（不影响周期，只影响是否复用结果）。

## 三、提示词（prompt）与配置文件的作用关系

### 1) prompt 位置

- `rdagent/scenarios/qlib/experiment/prompts.yaml`
  - `qlib_factor_experiment_setting`
  - `qlib_model_experiment_setting`

它们用于：
- UI 展示“实验设定”
- 给 LLM 一个“当前实验背景/默认设定”的文字描述

### 2) 配置文件位置

- `rdagent/scenarios/qlib/experiment/**/conf_*.yaml`

它们用于：
- 被 `qrun conf.yaml` 实际读取并执行
- 决定训练/验证/测试切分 (`segments`) 与回测时间 (`backtest.start_time/end_time`)

### 3) 关系与风险

- 如果 prompt 与 `conf_*.yaml` 的周期不一致，会出现：
  - “LLM/用户以为使用了某个周期”
  - “qrun 实际按另一个周期跑”

因此本次已将 `prompts.yaml` 的 Data Split 调整为与 baseline 配置一致（2010-01-07~2018-12-31 / 2019-01-01~2020-12-31 / 2021-01-01~2025-12-01）。

## 四、当前仓库中与周期强相关的字段清单（便于 grep）

- `segments.train/valid/test`
- `port_analysis_config.backtest.start_time/end_time`
- `data_handler_config.start_time/end_time`
- `fit_start_time/fit_end_time`
- （模型形态）`dataset_cls` / `step_len` / `num_timesteps`

