# 重要事项：RD-Agent → AIstock 权重策略现状与规划备忘录（v1）

## 0. 目的

本文档用于明确：

- RD-Agent（Qlib 回测）当前使用的组合构建/权重（仓位）策略是什么
- AIstock 在消费 RD-Agent 成果并落地到 miniQMT 时，v1 应采用的默认权重口径
- 未来 v2/v3 支持更复杂权重策略（softmax、风险平价等）的演进路径与治理要求

本文档的核心约束是：

- **可复现**：同一套 RD-Agent 产物在 AIstock 侧应可按固定口径复现策略
- **可审计**：权重策略的口径与参数必须可追溯、可入库
- **可演进**：未来可以在不重跑 RD-Agent 的情况下，在 AIstock 侧重算权重

---

## 1. 现状：RD-Agent（Qlib 回测）使用的组合策略

以 RD-Agent 当前模板配置为准：

- `rdagent/scenarios/qlib/experiment/factor_template/conf_baseline.yaml`
- `rdagent/scenarios/qlib/experiment/model_template/conf_baseline_factors_model.yaml`

其中 `port_analysis_config.strategy` 配置为：

- `class: TopkDropoutStrategy`
- `module_path: qlib.contrib.strategy`
- `kwargs.signal: <PRED>`
- `kwargs.topk: 50`
- `kwargs.n_drop: 5`

并且 `SigAnaRecord` 中 `ana_long_short: False`，表明为纯多头分析口径。

### 1.1 TopkDropoutStrategy 的含义（简述）

- 每个交易日根据 `signal`（这里为模型预测 `<PRED>`）做截面排序
- 选择 TopK（K=50）作为持仓候选
- 为降低换手，在每天调仓时仅替换其中一部分持仓（n_drop=5），再用新的高分标的补齐

该策略体现的要点是：

- **选股逻辑**：TopK
- **换手控制**：Dropout
- **权重口径**：通常为近似等权或策略内部默认权重（取决于 Qlib 版本实现细节）

---

## 2. v1 结论（重要）：AIstock 默认执行口径建议

### 2.1 v1 默认策略口径

为保证最短闭环与一致性，AIstock v1 建议：

- **纯多头**
- **TopK 等权** 作为默认权重生成方式
- TopK 与 n_drop 参数默认与 RD-Agent 回测保持一致（例如 topk=50，n_drop=5）

说明：

- v1 的目标是“能从 RD-Agent 产物直接落地到 miniQMT 执行”，同时“口径可解释、可验收”。
- TopK 等权最容易实现和验收；同时可通过保留 `score/rank` 等字段支撑未来演进。

### 2.2 v1 的推荐产物：signals（可执行信号表）

AIstock/miniQMT 侧最终应优先消费 `signals.parquet` / `signals.json`（强固定 schema），其中至少需要包含：

- 执行层核心列：`trade_date`, `instrument`, `target_weight`, `target_position`, `price_ref`, `universe_flag`
- 解释/治理列：`score`, `rank`, `pred_return`, `confidence`, `volatility_est`, `sector`, `industry`
- 溯源列：`generated_at_utc`, `task_run_id`, `loop_id`, `workspace_id`, `model_version`

并建议附带权重策略元信息（见下节）。

---

## 3. 权重策略元信息（必须纳入治理/溯源）

即使 v1 默认使用 TopK 等权，也必须明确记录权重策略参数，避免“同一份 score 被不同解释”。

建议的最小元信息字段（可写入 signals.json 顶层 meta，或写入 manifest/summary 的扩展字段）：

- `weight_method`：字符串
  - v1 建议值：`topk_equal_weight`
  - 若未来对齐 Qlib dropout 行为，可扩展：`topk_dropout_equal_weight`
- `topk`：整数（例如 50）
- `n_drop`：整数（例如 5；若不采用 dropout，可置 0 或 null）
- `rebalance_freq`：字符串（例如 `1d`）
- `max_weight` / `min_weight`：可选（若启用约束）

---

## 4. 未来规划：v2/v3 权重策略演进路径

### 4.1 v2：Softmax 权重

含义：根据 `score` 的强弱差异分配权重，强者权重更大。

- `target_weight ∝ exp(score / T)`，再归一化
- 需要引入 `temperature(T)`、score 标准化/截断、单票权重上限等治理参数

建议：

- v2 仍建议只在 TopK 内做 softmax（减少尾部噪声）

### 4.2 v3：风险平价 / 波动率缩放

含义：基于 `volatility_est` 做风险控制：高波动标的给更小权重。

- 典型：`target_weight ∝ (score_weight) / volatility_est`，再归一化
- 对 `volatility_est` 的估计窗口、数据质量提出要求

---

## 5. 关键原则：允许 AIstock 重算权重，但必须可复现

建议的总体原则：

- RD-Agent 可以输出“默认可执行权重”（v1 口径）
- 同时必须输出足够的“解释层数据”（`score/rank/confidence/volatility_est/...`），以支持 AIstock 未来重算
- AIstock 若在未来采用新权重策略，必须将 `weight_method` 与参数写入策略管理/入库系统，以支持回溯

---

## 6. 与对接文档的关系

- AIstock 对接总入口文档：`docs/2025-12-22_AIstock_RD-Agent_Registry_Integration_Guide.md`
  - 该文档中定义 `signals.parquet/signals.json` 的强固定 schema
  - 本备忘录补充权重策略“现状 + v1 决策 + v2/v3 规划”，用于长期维护与合并上游时参考
