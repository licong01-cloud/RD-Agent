# 2025-12-21

# .env 使用说明（RD-Agent 当前实现）

## 结论（必读）

- 本仓库中，`.env` 不是由所有模块“自动读取”的；它是由部分入口脚本通过 `python-dotenv` 的 `load_dotenv()` 主动加载进 `os.environ`。
- **当前优先级策略（A）：`.env` 覆盖系统环境变量**。
  - 这是因为多个入口使用了 `load_dotenv(..., override=True)`。
- `rdagent/core/conf.py` 在模块 import 末尾会执行 `RD_AGENT_SETTINGS = RDAgentSettings()`。
  - **这意味着：在 import `rdagent.core.conf` 之前，环境变量必须已经准备好**（否则 settings 会用到旧值/默认值）。

---

## 1) `.env` 如何生效

### 1.1 生效机制

- `.env` 文件本身不会自动影响 Python 进程。
- 只有在调用 `dotenv.load_dotenv(path, override=...)` 后，`.env` 里的键值才会被注入到进程的 `os.environ`。

### 1.2 当前仓库的关键入口

以下入口会主动加载 `.env`（因此“效果一致”）：

- `rdagent/app/cli.py`
  - `load_dotenv(".env", override=True)`
- `rdagent/log/ui/app.py`（Streamlit UI）
  - 会推断 repo root 并执行：`load_dotenv(<repo_root>/.env, override=True)`

一些 tools 也会做“尽力加载”（失败就忽略），例如：

- `tools/precompute_moneyflow_factors.py`

---

## 2) 当前优先级策略（A）：`.env` 覆盖系统环境变量

在使用 `load_dotenv(..., override=True)` 时：

- **如果同名变量同时存在**：`.env` 的值会覆盖当前进程已存在的环境变量。
- 如果只在系统环境变量中设置（`.env` 没有该键）：系统环境变量依旧生效。
- 如果只在 `.env` 中设置：`.env` 生效。

因此优先级可以理解为：

- **`.env` > 系统环境变量 > 代码默认值**

> 注意：这是“当前仓库入口脚本的行为”。如果你换成 `override=False`，优先级会变成 `系统环境变量 > .env > 默认值`。

---

## 3) 为什么不同启动命令可能有不同效果？

根因有两个：

- **(1) 是否调用了 `load_dotenv()`**
  - 调用了：`.env` 进 `os.environ`，settings 会读到。
  - 没调用：`.env` 不会生效（除非你在系统环境变量里设置）。

- **(2) 是否在 import `rdagent.core.conf` 之前调用**
  - `rdagent/core/conf.py` 会在 import 时实例化 `RD_AGENT_SETTINGS`。
  - 如果先 import 再 load dotenv：settings 已经被冻结为“旧环境”。

---

## 4) 启动方式对照表（是否一致）

### 4.1 推荐（一致）

- **CLI（推荐）**
  - 例：`python -m rdagent.app.cli fin_quant ...`
  - 结果：会加载 `.env`（override=True），并在 settings 初始化前生效。

- **UI（推荐）**
  - 例：通过 CLI 的 `ui` 子命令启动，或直接 `streamlit run rdagent/log/ui/app.py -- ...`
  - 结果：会加载 repo root 下 `.env`（override=True）。

### 4.2 可能不一致（需要你自己保证先 load dotenv）

- **直接运行某个模块/脚本**（不经过 `rdagent/app/cli.py`）
  - 例：`python rdagent/app/qlib_rd_loop/quant.py`（示例）
  - 风险：该脚本如果没有显式 `load_dotenv()`，那么 `.env` 不生效。

- **在交互式环境/Notebook 中直接 import**
  - 例：
    - `from rdagent.core.conf import RD_AGENT_SETTINGS`
  - 风险：如果你没有先 `load_dotenv()`，会用到默认值/旧环境。

---

## 5) 推荐使用方式（避免踩坑）

- **优先使用 `rdagent/app/cli.py` 作为统一入口。**
- 如果你必须写新脚本/新入口，请遵循：
  - 在 import 任何 `rdagent.core.conf` 之前执行 `load_dotenv(".env", override=True)`

---

## 6) 常见变量分类（如何设置才会被 RD-Agent settings 读取）

- `RDAgentSettings` 只会读取带前缀的变量：
  - **`RD_AGENT_SETTINGS__...`**
  - 并支持嵌套覆盖（因为启用了 `env_nested_delimiter="__"`）

- `.env` 中其它“非 `RD_AGENT_SETTINGS__` 前缀”的变量（例如 LLM、Qlib、路径等）
  - 仍然会进入 `os.environ`
  - 但是否被使用，取决于具体模块是否显式读取这些环境变量。
