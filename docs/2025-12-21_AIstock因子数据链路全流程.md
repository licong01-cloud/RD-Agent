# 2025-12-21 AIstock 因子数据链路全流程（数据准备→静态因子→合并→schema→RD-Agent 消费）

> 目标：把 AIstock 数据准备、RD-Agent 侧静态因子生成/合并、schema 生成与校验、以及在 Qlib/RD-Agent 场景中的消费关系串起来，形成可复现的端到端流程。
>
> 约定：你当前已将 AIstock 全量迁移到 `F:\Dev\AIstock\`，不再使用 `C:\Users\lc999\NewAIstock\AIstock\`。

---

## 0. 目录与关键约定（必须统一）

### 0.1 AIstock 数据根目录（统一到 F 盘）

- Snapshot（HDF5）根目录（Windows）：
  - `F:/Dev/AIstock/qlib_snapshots/<snapshot_id>/`
- Qlib bin 根目录（Windows）：
  - `F:/Dev/AIstock/qlib_bin/`
- Qlib csv 根目录（Windows）：
  - `F:/Dev/AIstock/qlib_csv/`
- AIstock factors 根目录（Windows）：
  - `F:/Dev/AIstock/factors/`

> 说明：RD-Agent 在 WSL 下运行时，Windows 路径通常应对应为 `/mnt/f/Dev/AIstock/...`。

### 0.2 关键环境变量（.env）

建议（你仓库当前 `.env` 已有这些值或同类项）：

- `QLIB_DATA_PATH=/mnt/f/Dev/AIstock/qlib_snapshots/<snapshot_id>`
- `AIstock_SNAPSHOT_ROOT=/mnt/f/Dev/AIstock/qlib_snapshots/<snapshot_id>`
- `AISTOCK_FACTORS_ROOT=/mnt/f/Dev/AIstock/factors`
- `AISTOCK_DATA_GOVERNANCE_DIR=/mnt/f/Dev/AIstock/data_governance`

以及 WSL 调度相关：

- `QLIB_RDAGENT_ROOT_WIN=F:/dev/RD-Agent-main`
- `QLIB_RDAGENT_ROOT_WSL=/mnt/f/dev/RD-Agent-main`
- `QLIB_BIN_ROOT_WIN=F:/Dev/AIstock/qlib_bin`
- `QLIB_CSV_ROOT_WIN=F:/Dev/AIstock/qlib_csv`

---

## 1. 数据准备（AIstock 侧产出）

### 1.1 Snapshot（HDF5）导出

AIstock 负责导出基础面板（通常在 snapshot 目录内）：

- `daily_pv.h5`：日线价量
- `moneyflow.h5`：资金流（`mf_*`）
- `daily_basic.h5`：每日指标（`db_*`）
- `instruments/all.txt`：标的与起止
- `calendars/day.txt`：交易日历（如存在）

这些文件用于：

- RD-Agent/CoSTEER 在 pandas 层计算自定义因子；
- 以及后续合并为静态因子 bundle（`static_factors.parquet`）。

### 1.2 Qlib bin（可选，但用于标准 qrun/backtest）

如果要跑 Qlib 的标准训练/回测（Alpha158、DatasetH 等），需要 AIstock 导出 Qlib bin：

- `F:/Dev/AIstock/qlib_bin/<bin_id>/...`

这一步与“静态因子 bundle”是并行链路：

- bin：给 Qlib 作为行情/回测底座
- HDF5/Parquet：给因子研发（CoSTEER/pandas）与 feature 扩展

---

## 2. 预计算因子生成（RD-Agent 仓库脚本）

本阶段输出到 `AISTOCK_FACTORS_ROOT`（例如 `/mnt/f/Dev/AIstock/factors`）下。

### 2.1 daily_basic 预计算因子

- 脚本：`precompute_daily_basic_factors.py`
- 输入：`<snapshot_root>/daily_basic.h5`
- 输出（目录/文件名示例）：
  - `<factors_root>/daily_basic_factors/result.h5`
  - `<factors_root>/daily_basic_factors/result.pkl`
  - `<factors_root>/daily_basic_factors/result.parquet`

### 2.2 moneyflow 预计算因子

- 脚本：`tools/precompute_moneyflow_factors.py`
- 输入：
  - `<snapshot_root>/moneyflow.h5`
  - `<snapshot_root>/daily_pv.h5`（用于 amount/volume 分母）
- 输出：
  - `<factors_root>/moneyflow_factors/result.pkl`

> 注意：该脚本包含 Windows→WSL 路径映射逻辑（`C:/...`→`/mnt/c/...` 这类）。在迁移到 F 盘后，应确保输入路径以 `F:/...` 或 `/mnt/f/...` 形式传入。

### 2.3 AE 重构误差因子（可选）

- 因子脚本：`factor_ae_recon_error_10d.py`
- 转换脚本：`convert_ae_factor_h5_to_parquet.py`
- 输出可被后续合并进静态 bundle。

---

## 3. 静态因子合并（static_factors.parquet + schema）

### 3.1 合并脚本

- 脚本：`tools/generate_static_factors_bundle.py`
- 输入：
  - snapshot：`daily_basic.h5`、`moneyflow.h5`、可选 `daily_pv.h5`
  - 可选预计算表（存在则合并）：
    - `<factors_root>/daily_basic_factors/result.pkl`
    - `<factors_root>/moneyflow_factors/result.pkl`
    - `<factors_root>/ae_recon_error_10d/result.pkl`
    - `<factors_root>/combined_static_factors.parquet`
  - 可选字段含义映射：`aistock_field_map.csv`（见第 3.3）

- 输出（仓库侧）：
  - `git_ignore_folder/factor_implementation_source_data/static_factors.parquet`
  - `git_ignore_folder/factor_implementation_source_data/static_factors_schema.json`
  - `git_ignore_folder/factor_implementation_source_data/static_factors_schema.csv`

并且按 `20251214_因子演进_debug_static_factors_rolling_retry备忘录.md` 的修复点：

- schema 也会同步写入 debug 目录：
  - `git_ignore_folder/factor_implementation_source_data_debug/static_factors_schema.json|csv`

### 3.2 rolling 派生列与 fallback

该脚本会从 moneyflow 原始字段派生一组更稳定的 `mf_*` 字段，并包含 5D/20D rolling 聚合。

当 `moneyflow_raw` 缺少分档字段导致派生为空时，会从可选表（尤其 `combined_static_factors.parquet`）中筛选 `mf_` 列作为 fallback 再尝试派生。

### 3.3 字段含义映射（AIstock_field_map_export_spec）

- 文档：`docs/AIstock_field_map_export_spec.md`
- AIstock 侧导出：`aistock_field_map.csv`（建议固定在 `.../metadata/` 下）
- RD-Agent 侧在执行 `generate_static_factors_bundle.py` 时通过 `--field-map` 指向该文件，从而把 `meaning_cn/unit/source_table` 写进 schema。

---

## 4. 因子 schema 生成（factor set schema）

### 4.1 factor set schema（daily_basic_factors / capital_flow_daily 等）

- 脚本：`tools/generate_factor_schemas.py`
- 输入：
  - `--factors-root <AISTOCK_FACTORS_ROOT>`（必填）
  - `--out-dir-governance <AISTOCK_DATA_GOVERNANCE_DIR>`（必填）
- 输出：
  - `<factors_root>/<factor_set>/metadata/<factor_set>_schema.json|csv`
  - `<out_dir_governance>/schemas/factors/<factor_set>_schema.json|csv`

> 注意：`tools/generate_factor_schemas.py` 内置了 `capital_flow_daily` 这个 factor set 名，但仓库当前未发现同名“产出 result.pkl/h5”的脚本入口；它更像是一个“治理/校验侧的预期集合名”。

---

## 5. 校验（schema 与产物一致性）

- 脚本：`tools/verify_factor_outputs.py`
- 输入：
  - `--factors-root <AISTOCK_FACTORS_ROOT>`
  - `--schema-dir <.../schemas/factors>`
  - `--factor-sets`（默认包含 `daily_basic_factors,capital_flow_daily`）
- 检查：
  - `<factors_root>/<factor_set>/result.pkl` 是否存在
  - `result.pkl` 的列是否与 `<factor_set>_schema.json` 一致

---

## 6. RD-Agent/Qlib 场景如何消费这些产物

### 6.1 因子运行数据目录准备

- 逻辑入口：`rdagent/scenarios/qlib/experiment/utils.py` 的 `generate_data_folder_from_qlib()`
- 优先复制：
  - repo 侧生成的 `static_factors.parquet` 与 schema（csv/json）到因子执行目录（含 debug）
- fallback：
  - 从 `AISTOCK_FACTORS_ROOT` 下的 `combined_static_factors.parquet` 等候选文件取静态表

### 6.2 LLM/CoSTEER 的“列名白名单”

- prompt/流程要求：因子实现必须以 `static_factors_schema.csv/json` 为白名单，禁止 LLM 编造列名。
- 参见：`docs/20251214_因子演进_debug_static_factors_rolling_retry备忘录.md`

---

## 7. 为什么会出现“写错目录”（F:\Dev\RD-Agent-main\C\Users\...）？

### 7.1 事实时间线（来自文件系统时间戳）

异常目录（真实存在）：

- `F:\Dev\RD-Agent-main\C\Users\lc999\NewAIstock\AIstock\factors\capital_flow_daily\`

时间戳（本机读取）：

- 目录创建时间：`2025-12-17 13:08:56`
- 目录修改时间：`2025-12-17 13:08:56`
- 目录内文件：
  - `result.h5` 修改时间：`2025-12-10 01:29:00`
  - `result.pkl` 修改时间：`2025-12-10 01:29:00`

### 7.2 根因判断（高置信）

- 目录名中出现 `C`（注意不是标准 `C:`），说明某次执行时传入的路径字符串里，盘符冒号被替换成了异常字符（复制粘贴/编码/字体替换常见）。
- 对 Python `Path` 来说，`C/...` 会被当成“普通相对路径片段”，从而在当前工作目录（repo 根）下被 `mkdir(parents=True)` 创建出来。
- 目录创建时间（12/17）晚于文件修改时间（12/10），说明：
  - `result.h5/result.pkl` 很可能先在其它位置生成；
  - 后续某次操作把它们复制/移动到了这个异常目录下（或解压/同步工具写入）。

> 结论：更像是“运行参数/路径字符串异常 + 脚本按参数创建目录”的组合问题，而不是脚本主动拼错路径。

### 7.3 与“C 盘迁移到 F 盘”的关系

你已经明确：`C:\Users\lc999\NewAIstock\AIstock` 已不用，全部迁移到 `F:\Dev\AIstock`。

因此后续应统一：

- 命令行参数用 `F:/Dev/AIstock/...`（Windows）或 `/mnt/f/Dev/AIstock/...`（WSL）
- `.env` 中也统一指向 `/mnt/f/Dev/AIstock/...`

并避免从旧文档/历史命令直接复制 `C:/Users/...` 路径（更避免复制后冒号被替换）。

---

## 8. 建议的“最小可复现”全流程命令（以 F 盘为准）

> 说明：以下是命令示例，用于说明顺序与参数来源；实际执行请根据你环境（Windows/WSL/conda）调整。

1) 生成 daily_basic_factors：

- 输入来自 snapshot；输出到 factors root。

2) 生成 moneyflow_factors：

- 运行 `tools/precompute_moneyflow_factors.py`
- `snapshot_root` 与 `factors_root` 来自 env（建议）或参数（如你自行包装脚本）。

3) 合并生成 static_factors bundle：

- 运行 `tools/generate_static_factors_bundle.py`
- 建议显式传入：
  - `--snapshot-root /mnt/f/Dev/AIstock/qlib_snapshots/<snapshot_id>`
  - `--aistock-factors-root /mnt/f/Dev/AIstock/factors`
  - 可选：`--field-map /mnt/f/Dev/AIstock/metadata/aistock_field_map.csv`

4) 生成 factor schemas：

- `python tools/generate_factor_schemas.py --factors-root F:/Dev/AIstock/factors --out-dir-governance F:/Dev/AIstock/data_governance`

5) 校验 factor outputs：

- `python tools/verify_factor_outputs.py --factors-root F:/Dev/AIstock/factors --schema-dir F:/Dev/AIstock/data_governance/schemas/factors`

---

## 9. 关联文档（现有）

- `docs/AIstock_Qlib_数据集使用备忘录.md`
- `docs/rdagent_precomputed_factors_cn.md`
- `docs/AIstock_field_map_export_spec.md`
- `docs/20251214_因子演进_debug_static_factors_rolling_retry备忘录.md`
- `docs/RD-Agent_AIstock_Qlib_备忘录.md`
