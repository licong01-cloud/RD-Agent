# 通过Log目录自动加载SOTA因子的方案

## 实施日期
2026-01-15

## 1. 需求分析

### 1.1 用户需求

**当前方案**：
- 需要手动指定workspace路径（如 `SOTA_WORKSPACE_PATH=./git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea`）
- 不够直观，需要手动查找workspace的UUID

**期望方案**：
- 通过指定log目录（如 `SOTA_LOG_PATH=./log/2026-01-14_16-14-52-886218`）
- 自动从log目录找到对应的workspace
- 自动应用SOTA因子

### 1.2 核心挑战

1. **log目录和workspace的关联**：如何通过log目录找到对应的workspace？
2. **自动查找workspace**：如何从log目录中提取workspace路径？
3. **向后兼容**：如何保持与现有方案的兼容性？

## 2. 方案设计

### 2.1 方案概述

**核心思路**：
1. 从log目录加载session文件
2. 从session中提取workspace路径
3. 使用workspace路径加载SOTA因子

**优势**：
- ✅ 更直观：log目录有时间戳，更容易定位
- ✅ 更简单：不需要手动查找workspace的UUID
- ✅ 更灵活：支持从任意log目录加载SOTA因子
- ✅ 向后兼容：同时支持workspace路径和log路径

### 2.2 实现原理

**Session文件结构**：
```
log/2026-01-14_16-14-52-886218/__session__/0/0_propose
log/2026-01-14_16-14-52-886218/__session__/0/1_exp_gen
log/2026-01-14_16-14-52-886218/__session__/0/2_coding
...
```

**Session文件内容**：
- Session文件是pickle序列化的 `LoopBase` 对象
- `LoopBase` 对象包含 `trace` 属性
- `trace.hist` 包含历史实验记录
- 每个实验记录包含 `experiment` 对象
- `experiment` 对象包含 `experiment_workspace` 属性
- `experiment_workspace` 包含 `workspace_path` 属性

**提取workspace路径的步骤**：
1. 加载session文件
2. 遍历 `trace.hist`
3. 找到第一个 `QlibFactorExperiment` 类型的实验
4. 提取 `experiment.experiment_workspace.workspace_path`

## 3. 代码实现

### 3.1 修改 `model_runner.py`

在 `@/f:/Dev/RD-Agent-main/rdagent/scenarios/qlib/developer/model_runner.py` 的 `develop` 方法开头添加：

```python
@cache_with_pickle(qlib_model_cache_key, CachedRunner.assign_cached_result)
def develop(self, exp: QlibModelExperiment) -> QlibModelExperiment:
    # ===== 新增：从log目录自动加载SOTA因子 =====
    load_sota_from_log = os.getenv("LOAD_SOTA_FROM_LOG", "false") == "true"
    if load_sota_from_log:
        sota_log_path = os.getenv("SOTA_LOG_PATH", "")
        if sota_log_path:
            try:
                sota_workspace_path = find_workspace_from_log(sota_log_path)
                if sota_workspace_path:
                    logger.info(f"Found workspace from log: {sota_workspace_path}")
                    
                    # 检查SOTA因子文件是否存在
                    sota_factors_path = Path(sota_workspace_path) / "combined_factors_df.parquet"
                    if sota_factors_path.exists():
                        try:
                            SOTA_factor = pd.read_parquet(sota_factors_path, engine="pyarrow")
                            logger.info(f"SOTA factors loaded from workspace: {sota_factors_path}")
                            logger.info(f"SOTA factors shape: {SOTA_factor.shape}")
                            
                            # 创建based_experiments
                            if not hasattr(exp, 'based_experiments') or exp.based_experiments is None:
                                exp.based_experiments = []
                            
                            # 创建一个虚拟的QlibFactorExperiment
                            sota_factor_exp = QlibFactorExperiment(sub_tasks=[])
                            sota_factor_exp.result = {
                                "IC": 0.0,  # 可以根据实际情况设置
                                "ICIR": 0.0,
                                "RankIC": 0.0,
                                "RankICIR": 0.0,
                            }
                            exp.based_experiments.append(sota_factor_exp)
                            logger.info(f"SOTA factor experiment added to based_experiments")
                        except Exception as e:
                            logger.error(f"Failed to load SOTA factors from workspace: {e}")
                    else:
                        logger.warning(f"SOTA factors file not found: {sota_factors_path}")
                else:
                    logger.warning(f"No workspace found in log path: {sota_log_path}")
            except Exception as e:
                logger.error(f"Failed to find workspace from log: {e}")
    ===== 新增结束 =====

    # 原有代码继续...
    if exp.based_experiments and exp.based_experiments[-1].result is None:
        exp.based_experiments[-1] = self.develop(exp.based_experiments[-1])

    exist_sota_factor_exp = False
    if exp.based_experiments:
        # ... 原有代码继续 ...
```

### 3.2 添加辅助函数

在 `model_runner.py` 文件顶部添加辅助函数：

```python
import pickle
from rdagent.scenarios.qlib.experiment.factor_experiment import QlibFactorExperiment


def find_workspace_from_log(log_path: str) -> str | None:
    """
    从log目录中查找workspace路径
    
    Args:
        log_path: log目录路径
        
    Returns:
        workspace路径，如果找不到则返回None
    """
    log_path = Path(log_path)
    if not log_path.exists():
        logger.warning(f"Log path does not exist: {log_path}")
        return None
    
    # 查找session目录
    session_path = log_path / "__session__"
    if not session_path.exists():
        logger.warning(f"Session directory not found: {session_path}")
        return None
    
    # 遍历session目录，找到最新的session文件
    loop_dirs = [d for d in session_path.iterdir() if d.is_dir() and d.name.isdigit()]
    if not loop_dirs:
        logger.warning(f"No loop directories found in session: {session_path}")
        return None
    
    # 按loop编号排序，取最大的
    loop_dirs.sort(key=lambda x: int(x.name))
    latest_loop_dir = loop_dirs[-1]
    
    # 遍历该loop目录下的所有session文件
    session_files = list(latest_loop_dir.glob("*.pkl"))
    if not session_files:
        logger.warning(f"No session files found in loop directory: {latest_loop_dir}")
        return None
    
    # 按文件名排序，取最新的
    session_files.sort(key=lambda x: x.name)
    latest_session_file = session_files[-1]
    
    # 加载session文件
    try:
        with open(latest_session_file, 'rb') as f:
            loop_obj = pickle.load(f)
        
        # 从loop对象中提取workspace路径
        if hasattr(loop_obj, 'trace') and hasattr(loop_obj.trace, 'hist'):
            for exp, feedback in loop_obj.trace.hist:
                # 检查是否是QlibFactorExperiment
                if isinstance(exp, QlibFactorExperiment):
                    if hasattr(exp, 'experiment_workspace') and hasattr(exp.experiment_workspace, 'workspace_path'):
                        workspace_path = str(exp.experiment_workspace.workspace_path)
                        logger.info(f"Found workspace from QlibFactorExperiment: {workspace_path}")
                        return workspace_path
        
        logger.warning(f"No QlibFactorExperiment found in session")
        return None
    except Exception as e:
        logger.error(f"Failed to load session file: {e}")
        return None
```

### 3.3 完整的修改代码

**修改位置**：`@/f:/Dev/RD-Agent-main/rdagent/scenarios/qlib/developer/model_runner.py`

**修改内容**：

1. 在文件顶部添加辅助函数
2. 在 `develop` 方法开头添加从log目录加载SOTA因子的逻辑

## 4. 使用方法

### 4.1 第一个任务：执行因子演进

```bash
# 执行因子演进
rdagent fin_factor --loop_n 10
```

### 4.2 第二个任务：执行模型演进（使用log目录）

```bash
# 配置环境变量
export LOAD_SOTA_FROM_LOG=true
export SOTA_LOG_PATH=./log/2026-01-14_16-14-52-886218
export USE_ALPHA_FACTORS=true

# 执行模型演进
rdagent fin_model --loop_n 10
```

### 4.3 验证SOTA因子加载

```bash
# 查看日志
grep "Found workspace from log" log/latest.log
grep "SOTA factors loaded from workspace" log/latest.log
grep "SOTA factor experiment added to based_experiments" log/latest.log
```

## 5. 方案对比

### 5.1 方案对比表

| 特性 | 方案1：指定workspace路径 | 方案2：指定log目录 |
|-----|----------------------|------------------|
| 指定方式 | `SOTA_WORKSPACE_PATH=./git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea` | `SOTA_LOG_PATH=./log/2026-01-14_16-14-52-886218` |
| 直观性 | ❌ 需要手动查找workspace的UUID | ✅ log目录有时间戳，更容易定位 |
| 易用性 | ❌ 需要手动查找workspace路径 | ✅ 只需要指定log目录 |
| 灵活性 | ❌ 只能指定特定workspace | ✅ 可以从任意log目录加载 |
| 自动化 | ❌ 需要手动查找workspace | ✅ 自动从log目录查找workspace |
| 向后兼容 | ✅ 支持 | ✅ 支持 |

### 5.2 推荐方案

**推荐使用方案2：指定log目录**

**理由**：
- ✅ 更直观：log目录有时间戳，更容易定位
- ✅ 更简单：不需要手动查找workspace的UUID
- ✅ 更灵活：支持从任意log目录加载SOTA因子
- ✅ 向后兼容：同时支持workspace路径和log路径

## 6. 执行脚本

### 6.1 完整执行脚本

创建 `run_factor_then_model_with_log.sh`：

```bash
#!/bin/bash

# ===== 第一个任务：因子演进 =====
echo "=========================================="
echo "开始执行第一个任务：10个Loop因子演进"
echo "=========================================="

# 执行因子演进
rdagent fin_factor --loop_n 10

# 获取最新的log目录
LATEST_LOG=$(ls -t log/ | grep -E "^[0-9]{4}-[0-9]{2}-[0-9]{2}" | head -n 1)
echo "最新的log目录: $LATEST_LOG"

# 验证log目录
if [ -z "$LATEST_LOG" ]; then
    echo "错误：找不到log目录"
    exit 1
fi

# ===== 第二个任务：模型演进 =====
echo "=========================================="
echo "开始执行第二个任务：10个Loop模型演进"
echo "=========================================="

# 配置环境变量
export LOAD_SOTA_FROM_LOG=true
export SOTA_LOG_PATH=./log/$LATEST_LOG
export USE_ALPHA_FACTORS=true

# 执行模型演进
rdagent fin_model --loop_n 10

echo "=========================================="
echo "所有任务执行完成"
echo "=========================================="
```

### 6.2 使用脚本

```bash
# 赋予执行权限
chmod +x run_factor_then_model_with_log.sh

# 执行脚本
./run_factor_then_model_with_log.sh
```

## 7. 验证步骤

### 7.1 验证workspace查找

```bash
# 查看日志
grep "Found workspace from log" log/latest.log
grep "Found workspace from QlibFactorExperiment" log/latest.log
```

### 7.2 验证SOTA因子加载

```bash
# 查看日志
grep "SOTA factors loaded from workspace" log/latest.log
grep "SOTA factors shape" log/latest.log
```

### 7.3 验证based_experiments

```bash
# 查看日志
grep "SOTA factor experiment added to based_experiments" log/latest.log
```

### 7.4 验证Alpha因子叠加

```bash
# 查看日志
grep "叠加Alpha因子" log/latest.log
```

## 8. 常见问题

### 8.1 如何找到正确的log目录？

```bash
# 查看所有log目录
ls -lt log/ | grep "^d"

# 查看最新的log目录
ls -t log/ | grep -E "^[0-9]{4}-[0-9]{2}-[0-9]{2}" | head -n 1

# 查看log目录的详细信息
ls -la log/2026-01-14_16-14-52-886218/
```

### 8.2 如果log目录不存在怎么办？

**检查log目录是否存在**：
```bash
ls -la log/
```

**如果不存在，重新执行因子演进**：
```bash
rdagent fin_factor --loop_n 10
```

### 8.3 如果找不到workspace怎么办？

**检查日志**：
```bash
grep "No QlibFactorExperiment found in session" log/latest.log
grep "Failed to load session file" log/latest.log
```

**手动指定workspace路径**：
```bash
export LOAD_SOTA_FROM_WORKSPACE=true
export SOTA_WORKSPACE_PATH=./git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea
```

### 8.4 可以同时使用log目录和workspace路径吗？

**优先级**：
1. 如果设置了 `LOAD_SOTA_FROM_LOG=true`，优先从log目录加载
2. 如果设置了 `LOAD_SOTA_FROM_WORKSPACE=true`，从workspace路径加载
3. 如果都设置了，优先级：log目录 > workspace路径

## 9. 高级配置

### 9.1 使用不同的log目录

```bash
# 使用指定的log目录
export LOAD_SOTA_FROM_LOG=true
export SOTA_LOG_PATH=./log/2026-01-14_16-14-52-886218
rdagent fin_model --loop_n 10
```

### 9.2 使用最新的log目录

```bash
# 自动使用最新的log目录
LATEST_LOG=$(ls -t log/ | grep -E "^[0-9]{4}-[0-9]{2}-[0-9]{2}" | head -n 1)
export LOAD_SOTA_FROM_LOG=true
export SOTA_LOG_PATH=./log/$LATEST_LOG
rdagent fin_model --loop_n 10
```

### 9.3 禁用Alpha因子

```bash
# 禁用Alpha因子
export LOAD_SOTA_FROM_LOG=true
export SOTA_LOG_PATH=./log/2026-01-14_16-14-52-886218
export USE_ALPHA_FACTORS=false
rdagent fin_model --loop_n 10
```

## 10. 总结

### 10.1 核心优势

✅ **更直观**：log目录有时间戳，更容易定位
✅ **更简单**：不需要手动查找workspace的UUID
✅ **更灵活**：支持从任意log目录加载SOTA因子
✅ **向后兼容**：同时支持workspace路径和log路径

### 10.2 使用步骤

1. **执行因子演进**：`rdagent fin_factor --loop_n 10`
2. **配置环境变量**：`LOAD_SOTA_FROM_LOG=true`、`SOTA_LOG_PATH=./log/2026-01-14_16-14-52-886218`
3. **执行模型演进**：`rdagent fin_model --loop_n 10`

### 10.3 预期效果

- ✅ 自动从log目录查找workspace
- ✅ 自动加载SOTA因子
- ✅ 自动叠加Alpha因子
- ✅ 模型演进使用SOTA因子和Alpha因子的组合

## 11. 附录

### 11.1 相关文档

- 从Workspace恢复任务执行方案分析_2026-01-14.md
- Session继续执行和不修改代码实现SOTA因子加载分析_2026-01-15.md
- 因子演进+模型演进完整实施方案（模型使用SOTA因子）_2026-01-14.md

### 11.2 相关代码文件

- `@/f:/Dev/RD-Agent-main/rdagent/scenarios/qlib/developer/model_runner.py`
- `@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/factor.py`
- `@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/model.py`

### 11.3 版本历史

| 版本 | 日期 | 说明 |
|-----|------|------|
| v1.0 | 2026-01-15 | 初始版本，提供通过log目录自动加载SOTA因子的方案 |
