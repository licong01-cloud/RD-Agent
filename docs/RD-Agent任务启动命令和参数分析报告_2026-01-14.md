# RD-Agent任务启动命令和参数分析报告

## 实施日期
2026-01-14

## 1. 问题提出

用户要求再次分析RD-Agent任务的启动命令和参数，重点回答以下问题：

**问题1：RD-Agent任务有哪些启动命令？**
- 有哪些可用的命令行接口？
- 每个命令的作用是什么？

**问题2：RD-Agent任务支持哪些命令行参数？**
- 是否可以指定workspace开始继续运行？
- 是否有其他重要的参数？

**问题3：是否可以从指定workspace继续运行？**
- 是否能实现继续上一个任务？
- 继续运行的机制是什么？

## 2. RD-Agent启动命令分析

### 2.1 主要启动命令

从`@/f:/Dev/RD-Agent-main/rdagent/app/cli.py:84-96`可以看到，RD-Agent提供了以下启动命令：

```python
app.command(name="fin_factor")(fin_factor)
app.command(name="fin_model")(fin_model)
app.command(name="fin_quant")(fin_quant)
app.command(name="fin_factor_report")(fin_factor_report)
app.command(name="general_model")(general_model)
app.command(name="data_science")(data_science)
app.command(name="grade_summary")(grade_summary)
app.command(name="ui")(ui)
app.command(name="server_ui")(server_ui)
app.command(name="health_check")(health_check)
app.command(name="collect_info")(collect_info)
app.command(name="ds_user_interact")(ds_user_interact)
app.command(name="results_api")(results_api)
```

### 2.2 命令详细说明

#### 2.2.1 金融量化场景命令

**1. `rdagent fin_quant`**
- **作用**：因子和模型联合演进
- **描述**：Qlib自循环因子&模型提议和实现应用
- **入口文件**：`@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/quant.py:121-143`

**2. `rdagent fin_factor`**
- **作用**：因子演进
- **描述**：Qlib自循环因子提议和实现应用
- **入口文件**：`@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/factor.py:31-56`

**3. `rdagent fin_model`**
- **作用**：模型演进
- **描述**：Qlib自循环模型提议和实现应用
- **入口文件**：`@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/model.py:18-39`

**4. `rdagent fin_factor_report --report-folder=<path>`**
- **作用**：从财务报告提取因子
- **描述**：基于财务报告的Qlib因子提取和实现应用
- **入口文件**：`@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/factor_from_report.py`

#### 2.2.2 数据科学场景命令

**5. `rdagent data_science --competition <name>`**
- **作用**：Kaggle竞赛自动模型调优和特征工程
- **描述**：自循环模型提议和特征工程实现应用
- **入口文件**：`@/f:/Dev/RD-Agent-main/rdagent/app/data_science/loop.py`

#### 2.2.3 通用场景命令

**6. `rdagent general_model <paper_url>`**
- **作用**：自动模型研发助手
- **描述**：模型提取和实现应用
- **入口文件**：`@/f:/Dev/RD-Agent-main/rdagent/app/general_model/general_model.py`

#### 2.2.4 辅助命令

**7. `rdagent ui --port 19899 --log-dir <log_folder> --data_science`**
- **作用**：启动Web应用查看日志追踪
- **描述**：显示运行日志的Web界面

**8. `rdagent health_check`**
- **作用**：健康检查
- **描述**：检查Docker安装和端口占用情况

**9. `rdagent grade_summary`**
- **作用**：生成MLE-bench成绩总结

**10. `rdagent results_api`**
- **作用**：启动只读结果API服务器（用于AIstock集成）

## 3. 命令行参数分析

### 3.1 金融量化场景参数

从`@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/quant.py:121-143`可以看到，`fin_quant`命令支持以下参数：

```python
def main(
    path=None,
    step_n: int | None = None,
    loop_n: int | None = None,
    all_duration: str | None = None,
    checkout: bool = True,
):
```

**参数说明：**

1. **`path`** (可选)
   - **类型**：str | None
   - **默认值**：None
   - **作用**：指定session文件路径，用于继续运行
   - **示例**：`$LOG_PATH/__session__/1/0_propose`
   - **说明**：如果不指定，则创建新的session；如果指定，则从该session继续运行

2. **`step_n`** (可选)
   - **类型**：int | None
   - **默认值**：None
   - **作用**：指定运行的步数
   - **说明**：None表示运行直到完成或出错

3. **`loop_n`** (可选)
   - **类型**：int | None
   - **默认值**：None
   - **作用**：指定运行的循环数
   - **说明**：None表示运行直到完成或出错

4. **`all_duration`** (可选)
   - **类型**：str | None
   - **默认值**：None
   - **作用**：指定总运行时长
   - **格式**：接受计时器支持的格式（如"1h"、"30m"等）

5. **`checkout`** (可选)
   - **类型**：bool
   - **默认值**：True
   - **作用**：是否checkout（使用现有文件夹并清除后续日志）
   - **说明**：True表示使用现有文件夹并清除后续日志；False表示使用现有文件夹但保留后续日志

### 3.2 因子演进场景参数

从`@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/factor.py:31-56`可以看到，`fin_factor`命令支持以下参数：

```python
def main(
    path: Optional[str] = None,
    step_n: Optional[int] = None,
    loop_n: Optional[int] = None,
    all_duration: str | None = None,
    checkout: Annotated[bool, typer.Option("--checkout/--no-checkout", "-c/-C")] = True,
    checkout_path: Optional[str] = None,
):
```

**额外参数：**

6. **`checkout_path`** (可选)
   - **类型**：Optional[str]
   - **默认值**：None
   - **作用**：指定checkout路径
   - **说明**：如果指定，新session将保存到该路径，原路径保持不变

### 3.3 模型演进场景参数

从`@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/model.py:18-39`可以看到，`fin_model`命令支持与`fin_quant`相同的参数。

## 4. 从指定路径继续运行的机制

### 4.1 Session恢复机制

从`@/f:/Dev/RD-Agent-main/rdagent/utils/workflow/loop.py:714-779`可以看到，RD-Agent提供了完整的session恢复机制：

```python
@classmethod
def load(
    cls,
    path: str | Path,
    checkout: bool | Path | str = False,
    replace_timer: bool = True,
) -> "LoopBase":
    """
    Load a session from a given path.

    Parameters
    ----------
    path : str | Path
        The path to the session file.
    checkout : bool | Path | str
        If True, the new loop will use the existing folder and clear logs for sessions after the one corresponding to the given path.
        If False, the new loop will use the existing folder but keep the logs for sessions after the one corresponding to the given path.
        If a path (or a str like Path) is provided, the new loop will be saved to that path, leaving the original path unchanged.
    replace_timer : bool
        If a session is loaded, determines whether to replace the timer with session.timer.
        Default is True, which means the session timer will be replaced with the current timer.
        If False, the session timer will not be replaced.

    Returns
    -------
    LoopBase
        An instance of LoopBase with the loaded session.
    """
```

**关键特性：**

1. **自动加载最新session**
   - 如果`path`是目录，会自动加载最新的session文件
   - 如果`path`是文件，则直接加载该文件

2. **Session文件格式**
   - Session文件使用pickle序列化
   - 包含整个LoopBase对象的状态

3. **Checkout控制**
   - 支持三种模式：True、False、指定路径
   - 控制是否清除后续日志

4. **计时器替换**
   - 支持替换或不替换计时器
   - 默认替换为当前计时器

### 4.2 Session保存机制

从`@/f:/Dev/RD-Agent-main/rdagent/utils/workflow/loop.py:687-693`可以看到，RD-Agent在每个步骤完成后自动保存session：

```python
def dump(self, path: str | Path) -> None:
    if RD_Agent_TIMER_wrapper.timer.started:
        RD_Agent_TIMER_wrapper.timer.update_remain_time()
    path = Path(path)
    path.parent.mkdir(parents=True, exist_ok=True)
    with path.open("wb") as f:
        pickle.dump(self, f)
```

**保存时机：**
- 每个步骤成功完成后自动保存
- 保存路径：`$LOG_PATH/__session__/{loop_idx}/{step_idx}_{step_name}`

### 4.3 Session包含的信息

从`@/f:/Dev/RD-Agent-main/rdagent/utils/workflow/loop.py:781-791`可以看到，session保存了LoopBase对象的所有状态：

```python
def __getstate__(self) -> dict[str, Any]:
    res = {}
    for k, v in self.__dict__.items():
        if k not in ["queue", "semaphores", "_pbar"]:
            res[k] = v
    return res
```

**包含的关键信息：**
- `loop_idx`: 当前循环索引
- `step_idx`: 每个循环的步骤索引
- `loop_prev_out`: 每个循环的输出
- `loop_trace`: 循环追踪信息
- `trace`: 实验历史（包括`trace.hist`）
- `task_run_id`: 任务运行ID
- `timer`: 计时器状态

**不包含的信息：**
- `queue`: 异步队列
- `semaphores`: 信号量
- `_pbar`: 进度条

### 4.4 继续运行的示例

从代码注释中可以看到继续运行的示例：

```python
"""
Auto R&D Evolving loop for fintech factors.
You can continue running session by
.. code-block:: python
    dotenv run -- python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__/1/0_propose  --step_n 1   # `step_n` is a optional paramter
"""
```

**实际使用示例：**

1. **从最新session继续运行**
   ```bash
   python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --step_n 1
   ```

2. **从指定session继续运行**
   ```bash
   python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__/1/0_propose --step_n 1
   ```

3. **继续运行指定循环数**
   ```bash
   python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --loop_n 5
   ```

4. **继续运行指定时长**
   ```bash
   python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --all_duration "1h"
   ```

## 5. Workspace与Session的关系

### 5.1 Workspace的定义

从之前的分析可知，Workspace是RD-Agent用来存储代码和数据的工作空间：

**Workspace包含：**
- 代码文件（`model.py`、`factor.py`等）
- 数据文件（`combined_factors_df.parquet`、`ret.pkl`等）
- 输出文件（日志、执行结果等）

**Workspace特点：**
- 每个实验有一个独立的workspace
- Workspace路径：`RD_AGENT_SETTINGS.workspace_path / uuid.uuid4().hex`
- Workspace不保存实验历史（`trace.hist`）

### 5.2 Session的定义

Session是RD-Agent用来保存整个workflow状态的机制：

**Session包含：**
- LoopBase对象的所有状态
- 实验历史（`trace.hist`）
- 循环索引和步骤索引
- 每个循环的输出
- 计时器状态

**Session特点：**
- Session文件使用pickle序列化
- Session路径：`$LOG_PATH/__session__/{loop_idx}/{step_idx}_{step_name}`
- Session保存了完整的workflow状态

### 5.3 Workspace与Session的区别

| 特性 | Workspace | Session |
|-----|-----------|---------|
| **存储内容** | 代码、数据、输出文件 | Workflow状态、实验历史 |
| **保存位置** | `RD_AGENT_SETTINGS.workspace_path` | `$LOG_PATH/__session__` |
| **序列化方式** | 文件系统 | Pickle |
| **恢复粒度** | 实验级别 | Workflow级别 |
| **包含trace.hist** | ❌ 否 | ✅ 是 |
| **包含loop_idx** | ❌ 否 | ✅ 是 |
| **包含step_idx** | ❌ 否 | ✅ 是 |

### 5.4 Workspace与Session的关系

**关系说明：**

1. **Session包含Workspace引用**
   - Session中的`loop_prev_out`包含了实验对象
   - 实验对象中包含了`experiment_workspace`（即Workspace）

2. **Session恢复会恢复Workspace引用**
   - 从Session恢复时，会恢复Workspace的路径
   - 但是不会恢复Workspace的内容

3. **Workspace是Session的子集**
   - Workspace只存储代码和数据
   - Session存储了整个workflow的状态，包括Workspace的引用

## 6. 回答用户的问题

### 6.1 问题1：RD-Agent任务有哪些启动命令？

**回答：**

RD-Agent提供了以下主要启动命令：

1. **金融量化场景**
   - `rdagent fin_quant` - 因子和模型联合演进
   - `rdagent fin_factor` - 因子演进
   - `rdagent fin_model` - 模型演进
   - `rdagent fin_factor_report --report-folder=<path>` - 从财务报告提取因子

2. **数据科学场景**
   - `rdagent data_science --competition <name>` - Kaggle竞赛自动模型调优和特征工程

3. **通用场景**
   - `rdagent general_model <paper_url>` - 自动模型研发助手

4. **辅助命令**
   - `rdagent ui --port 19899 --log-dir <log_folder> --data_science` - 启动Web应用查看日志
   - `rdagent health_check` - 健康检查
   - `rdagent grade_summary` - 生成MLE-bench成绩总结
   - `rdagent results_api` - 启动只读结果API服务器

### 6.2 问题2：RD-Agent任务支持哪些命令行参数？

**回答：**

RD-Agent任务支持以下命令行参数：

1. **`path`** - 指定session文件路径，用于继续运行
2. **`step_n`** - 指定运行的步数
3. **`loop_n`** - 指定运行的循环数
4. **`all_duration`** - 指定总运行时长
5. **`checkout`** - 是否checkout（使用现有文件夹并清除后续日志）
6. **`checkout_path`** - 指定checkout路径（仅fin_factor支持）

**是否可以指定workspace开始继续运行？**

❌ **不能直接指定workspace**

- RD-Agent不支持直接从workspace路径继续运行
- 支持从session路径继续运行
- Session路径格式：`$LOG_PATH/__session__/{loop_idx}/{step_idx}_{step_name}`

**原因：**
- Workspace只存储代码和数据
- Session存储了完整的workflow状态
- 继续运行需要恢复workflow状态，而不仅仅是代码和数据

### 6.3 问题3：是否可以从指定workspace继续运行？

**回答：**

❌ **不能直接从workspace继续运行**

**原因：**

1. **Workspace不包含workflow状态**
   - Workspace只包含代码、数据、输出文件
   - Workspace不包含实验历史（`trace.hist`）
   - Workspace不包含循环索引（`loop_idx`）和步骤索引（`step_idx`）

2. **继续运行需要完整的workflow状态**
   - 需要恢复`trace.hist`
   - 需要恢复`loop_idx`和`step_idx`
   - 需要恢复每个循环的输出（`loop_prev_out`）

3. **Session是恢复的正确方式**
   - Session包含了完整的workflow状态
   - Session使用pickle序列化，可以恢复所有状态
   - Session在每个步骤完成后自动保存

**但是：**

✅ **可以从session继续运行**

**使用方法：**

1. **从最新session继续运行**
   ```bash
   python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --step_n 1
   ```

2. **从指定session继续运行**
   ```bash
   python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__/1/0_propose --step_n 1
   ```

3. **继续运行指定循环数**
   ```bash
   python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --loop_n 5
   ```

4. **继续运行指定时长**
   ```bash
   python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --all_duration "1h"
   ```

## 7. 结论

### 7.1 核心结论

1. **RD-Agent提供了完整的session恢复机制**
   - ✅ 支持从session继续运行
   - ✅ 支持指定运行的步数、循环数、时长
   - ✅ 支持checkout控制

2. **RD-Agent不支持直接从workspace继续运行**
   - ❌ 不能指定workspace路径继续运行
   - ❌ Workspace不包含workflow状态
   - ❌ Workspace无法恢复实验历史

3. **Session是恢复的正确方式**
   - ✅ Session包含了完整的workflow状态
   - ✅ Session可以恢复实验历史
   - ✅ Session可以恢复循环索引和步骤索引

### 7.2 实际应用建议

**场景1：任务中断后继续运行**

```bash
# 从最新session继续运行
python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --step_n 1
```

**场景2：从指定步骤继续运行**

```bash
# 从指定session继续运行
python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__/1/0_propose --step_n 1
```

**场景3：限制继续运行的循环数**

```bash
# 继续运行5个循环
python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --loop_n 5
```

**场景4：限制继续运行的时长**

```bash
# 继续运行1小时
python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --all_duration "1h"
```

### 7.3 与之前分析的区别

**之前的分析（从Workspace恢复任务执行方案分析_2026-01-14.md）：**
- 认为需要修改代码才能从workspace恢复任务
- 推荐方案：修改`model_runner.py`，从workspace加载SOTA因子

**本次分析的新发现：**
- RD-Agent已经提供了完整的session恢复机制
- 不需要修改代码就可以从session继续运行
- Session包含了完整的workflow状态，包括实验历史

**关键区别：**
- Workspace ≠ Session
- Workspace只存储代码和数据
- Session存储了完整的workflow状态
- 继续运行应该使用session，而不是workspace

### 7.4 最终建议

**推荐使用session恢复机制：**

1. ✅ **使用session继续运行**
   - 无需修改代码
   - 支持完整的workflow状态恢复
   - 支持多种控制参数

2. ❌ **不要尝试从workspace继续运行**
   - Workspace不包含workflow状态
   - 无法恢复实验历史
   - 无法恢复循环索引和步骤索引

3. ✅ **使用session参数控制继续运行**
   - `--step_n`：控制运行的步数
   - `--loop_n`：控制运行的循环数
   - `--all_duration`：控制运行的时长
   - `--checkout`：控制是否清除后续日志

## 8. 附录

### 8.1 Session路径结构

```
$LOG_PATH/
└── __session__/
    ├── 0/
    │   ├── 0_direct_exp_gen
    │   ├── 1_coding
    │   ├── 2_running
    │   ├── 3_feedback
    │   └── 4_record
    ├── 1/
    │   ├── 0_direct_exp_gen
    │   ├── 1_coding
    │   ├── 2_running
    │   ├── 3_feedback
    │   └── 4_record
    └── 2/
        ├── 0_direct_exp_gen
        ├── 1_coding
        ├── 2_running
        ├── 3_feedback
        └── 4_record
```

### 8.2 常用命令示例

**1. 启动新的任务**
```bash
python rdagent/app/qlib_rd_loop/quant.py
```

**2. 从最新session继续运行**
```bash
python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__
```

**3. 从指定session继续运行**
```bash
python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__/1/0_propose
```

**4. 继续运行1个步骤**
```bash
python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --step_n 1
```

**5. 继续运行5个循环**
```bash
python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --loop_n 5
```

**6. 继续运行1小时**
```bash
python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --all_duration "1h"
```

**7. 继续运行但不清除后续日志**
```bash
python rdagent/app/qlib_rd_loop/quant.py $LOG_PATH/__session__ --no-checkout
```

**8. 继续运行并保存到新路径**
```bash
python rdagent/app/qlib_rd_loop/factor.py $LOG_PATH/__session__ --checkout_path /new/log/path
```

### 8.3 版本历史

| 版本 | 日期 | 说明 |
|-----|------|------|
| v1.0 | 2026-01-14 | 初始版本，分析RD-Agent任务启动命令和参数，评估从指定路径继续运行的可行性 |
