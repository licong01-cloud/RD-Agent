# 中小市值股票筛选方案

> 创建日期：2026-02-10
> 状态：方案设计阶段，尚未实施

## 1. 需求背景

当前 RDAgent 因子演进和回测覆盖全 A 股（约 5000+ 支），未做市值分层。用户希望聚焦于**中小盘股**（流通市值 < 100 亿），原因：

- 中小盘股信息不对称更强，量化因子的 alpha 空间更大
- 大盘蓝筹被机构充分定价，纯因子策略难以获得超额收益
- 资金容量匹配：当前回测账户 1 亿，适合中小盘持仓

## 2. 核心问题：在哪一层做市值过滤？

### 2.1 方案对比

| 层级 | 方式 | 优点 | 缺点 |
|------|------|------|------|
| **A. 因子层（提示词引导）** | 在提示词中引导 LLM 设计对中小盘有效的因子 | 不需改代码；因子对全市场计算 | 软性约束，无法硬性排除大盘股 |
| **B. 模型训练层** | 训练时只使用中小盘股票的样本 | 模型更聚焦 | 样本量减少；需修改 data_handler 配置 |
| **C. 策略层（选股过滤）** | 在 `EnhancedTopkDropoutStrategy` 中过滤大盘股 | 因子和模型不受影响；灵活可配置 | 需要策略能读取市值数据 |
| **D. 股票池层（instruments）** | 通过 QLib instruments 文件定义中小盘股票池 | QLib 原生支持；全链路生效 | 需要定期更新股票池文件；市值变化导致进出池 |

### 2.2 推荐方案

**推荐采用 C + D 组合方案**，即：

1. **主方案（D）**：通过 QLib instruments 文件定义中小盘股票池，在数据加载、模型训练、回测全链路生效
2. **辅助方案（C）**：在策略层增加 `max_circ_mv` 参数作为安全网，防止市值突变导致大盘股进入持仓
3. **可选增强（A）**：在提示词中引导因子设计偏向中小盘特征（待 D+C 验证后再决定是否启用）

**暂不推荐 B 方案**：减少训练样本会影响模型泛化能力，且中小盘的定义会随时间变化。

## 3. 方案 D 详细设计：QLib Instruments 股票池

### 3.1 原理

QLib 通过 `instruments` 目录下的文本文件定义股票池。每行格式为：

```
<instrument_id>\t<start_date>\t<end_date>
```

例如：
```
000001.SZ	2018-08-01	2025-12-01
000002.SZ	2018-08-01	2025-12-01
```

在 YAML 配置中通过 `filter_pipe` 或直接指定 instruments 文件来使用。

### 3.2 实施步骤

#### 步骤 1：生成中小盘股票池文件

创建脚本 `tools/generate_smallcap_instruments.py`：

```python
"""
根据 static_factors.parquet 中的 db_circ_mv 字段，
生成中小盘股票池 instruments 文件。

逻辑：
- 对每个交易日，筛选 db_circ_mv <= 阈值（默认 1000000 万元 = 100 亿）的股票
- 要求该股票在筛选期内至少 80% 的交易日满足市值条件（避免频繁进出）
- 输出 QLib instruments 格式文件
"""

import pandas as pd
from pathlib import Path

def generate_smallcap_instruments(
    static_factors_path: str,
    output_path: str,
    max_circ_mv: float = 1_000_000,  # 万元，100亿
    min_ratio: float = 0.8,           # 至少 80% 交易日满足条件
    start_date: str = "2018-08-01",
    end_date: str = "2025-12-01",
):
    df = pd.read_parquet(static_factors_path, columns=["db_circ_mv"])
    
    # 筛选日期范围
    df = df.loc[start_date:end_date]
    
    # 对每个 instrument，计算满足市值条件的交易日比例
    is_small = (df["db_circ_mv"] <= max_circ_mv)
    
    # 按 instrument 分组统计
    grouped = is_small.groupby(level="instrument")
    ratio = grouped.mean()
    
    # 筛选满足条件的股票
    valid_instruments = ratio[ratio >= min_ratio].index.tolist()
    
    # 获取每个股票的有效日期范围
    lines = []
    for inst in sorted(valid_instruments):
        inst_data = df.loc[(slice(None), inst), :]
        if inst_data.empty:
            continue
        dates = inst_data.index.get_level_values("datetime")
        inst_start = max(dates.min(), pd.Timestamp(start_date))
        inst_end = min(dates.max(), pd.Timestamp(end_date))
        lines.append(f"{inst}\t{inst_start.strftime('%Y-%m-%d')}\t{inst_end.strftime('%Y-%m-%d')}")
    
    Path(output_path).parent.mkdir(parents=True, exist_ok=True)
    with open(output_path, "w") as f:
        f.write("\n".join(lines))
    
    print(f"Generated {len(lines)} instruments to {output_path}")
```

输出文件路径建议：
```
f:/Dev/AIstock/qlib_bin/qlib_bin_20251209/instruments/smallcap100.txt
```

#### 步骤 2：修改 YAML 配置文件

在所有 `conf_*.yaml` 文件中，将 `market` 从 `csi300`/`csi500` 改为自定义股票池：

```yaml
# 修改前
market: &market csi300

# 修改后
market: &market smallcap100
```

或者使用 filter_pipe 方式（更灵活）：

```yaml
data_handler_config: &data_handler_config
    start_time: 2018-08-01
    end_time: 2025-12-01
    fit_start_time: 2018-08-01
    fit_end_time: 2020-12-31
    instruments: smallcap100
```

#### 步骤 3：验证股票池

创建验证脚本确认：
- 股票数量是否合理（预期 2000-3500 支）
- 是否覆盖了主要中小盘指数成分股
- 时间范围是否与训练/测试期对齐

### 3.3 股票池更新策略

| 策略 | 说明 |
|------|------|
| **静态池** | 一次性生成，不随时间变化。简单但可能包含已变为大盘的股票 |
| **滚动池** | 每季度/半年重新生成。更准确但增加维护成本 |
| **动态池** | 每个交易日实时判断。最准确但实现复杂 |

**建议初期使用静态池**，待策略验证有效后再考虑滚动更新。

## 4. 方案 C 详细设计：策略层市值过滤

### 4.1 修改 `EnhancedTopkDropoutStrategy`

在 `custom_strategy.py` 中新增以下内容：

#### 新增参数

```python
def __init__(self, 
             ...,
             max_circ_mv=None,            # 流通市值上限（万元），None 表示不过滤
             static_factors_path=None,    # static_factors.parquet 路径
             **kwargs):
```

#### 新增方法

```python
def _load_circ_mv_data(self, static_factors_path=None):
    """初始化时一次性加载 db_circ_mv 数据到内存"""
    # 按优先级搜索 parquet 文件路径
    # 仅加载 db_circ_mv 一列，内存占用约 50-100MB

def _filter_by_market_cap(self, stock_scores, trade_date):
    """在每个交易日，过滤掉流通市值超过阈值的股票"""
    # 从缓存的市值数据中取当日数据
    # 过滤并返回符合条件的股票评分
```

#### 调用位置

在 `generate_trade_decision()` 中，评分归一化后、选股前调用：

```python
all_pred_scores = self._normalize_signal_scores(all_pred_scores, pred_end_time)

# 市值过滤（仅当 max_circ_mv 不为 None 时生效）
all_pred_scores = self._filter_by_market_cap(all_pred_scores, trade_start_time)
```

### 4.2 YAML 配置示例

```yaml
port_analysis_config: &port_analysis_config
    strategy:
        class: EnhancedTopkDropoutStrategy
        module_path: rdagent.scenarios.qlib.experiment.factor_template.custom_strategy
        kwargs:
            signal: <PRED>
            topk: 50
            n_drop: 5
            min_score: 0.1
            max_position_ratio: 0.90
            stop_loss: -0.10
            max_circ_mv: 1000000  # 100亿（万元）
```

### 4.3 数据依赖

策略需要读取 `static_factors.parquet` 中的 `db_circ_mv` 字段。文件搜索优先级：

1. `static_factors_path` 参数指定的路径
2. `F:/Dev/AIstock/factors/combined_static_factors.parquet`（Windows）
3. `/mnt/f/Dev/AIstock/factors/combined_static_factors.parquet`（WSL）
4. `F:/Dev/RD-Agent-main/git_ignore_folder/factor_implementation_source_data/static_factors.parquet`

## 5. 方案 A 详细设计：提示词引导（可选增强）

### 5.1 修改位置

`rdagent/scenarios/qlib/prompts.yaml` 的 `factor_hypothesis_specification` 部分。

### 5.2 新增内容

在现有第 7 条之后新增第 8 条：

```yaml
  8. **Small/Mid-Cap Preference（中小盘偏好）：**
    - 当前策略聚焦于中小盘股（流通市值 < 100亿），策略层已通过市值过滤排除大盘股。
    - 因子设计应优先考虑对中小盘股有效的信号，例如：
      - 筹码集中度变化（cp_winner_rate、成本分位价差）在中小盘中更具区分度
      - 股东人数变化（bb_holder_num）对中小盘股的筹码锁定信号更敏感
      - 主力资金净流入占比（mf_main_net_amt / db_circ_mv）在中小盘中信噪比更高
      - 动态PE与静态PE的偏离度（bb_pe_dyn vs db_pe）在成长型中小盘中更有意义
    - 避免设计仅对大盘蓝筹有效的因子（如纯股息率排序、低波动策略等）。
```

### 5.3 注意事项

- 此修改为**软性引导**，不保证 LLM 严格遵守
- 建议在方案 D+C 验证有效后再启用，避免过早约束因子探索空间

## 6. 涉及的文件清单

### 需要新增的文件

| 文件 | 说明 |
|------|------|
| `tools/generate_smallcap_instruments.py` | 生成中小盘股票池脚本 |
| `qlib_bin/.../instruments/smallcap100.txt` | 中小盘股票池文件 |

### 需要修改的文件

| 文件 | 修改内容 |
|------|----------|
| `factor_template/custom_strategy.py` | 新增 `max_circ_mv`/`static_factors_path` 参数、`_load_circ_mv_data`/`_filter_by_market_cap` 方法 |
| `factor_template/conf_baseline.yaml` | market 改为 smallcap100 或添加 max_circ_mv |
| `factor_template/conf_combined_factors.yaml` | 同上 |
| `factor_template/conf_combined_factors_dynamic.yaml` | 同上 |
| `factor_template/conf_combined_factors_sota_model.yaml` | 同上 |
| `model_template/conf_baseline_factors_model.yaml` | 同上 |
| `model_template/conf_baseline_factors_model_standalone.yaml` | 同上 |
| `model_template/conf_sota_factors_model.yaml` | 同上 |
| `rdagent/scenarios/qlib/prompts.yaml` | 新增中小盘偏好提示词（可选） |

## 7. 实施计划

### Phase 1：基础验证（建议先完成当前 RDAgent 演进任务后再实施）

1. 编写 `generate_smallcap_instruments.py` 脚本
2. 生成 `smallcap100.txt` 股票池文件
3. 验证股票数量和覆盖范围

### Phase 2：策略层实施

4. 修改 `custom_strategy.py`，添加市值过滤功能
5. 在一个 YAML 配置中启用 `max_circ_mv` 参数进行测试
6. 对比全市场 vs 中小盘的回测结果

### Phase 3：全链路切换

7. 将所有 YAML 配置的 market 改为 smallcap100
8. 运行完整的 RDAgent 因子演进流程
9. 对比演进效果

### Phase 4：提示词优化（可选）

10. 根据 Phase 3 的结果，决定是否启用中小盘偏好提示词
11. 如启用，修改 `prompts.yaml` 并观察因子设计质量变化

## 8. 风险与注意事项

- **样本量减少**：中小盘约 2000-3500 支，相比全市场 5000+ 减少约 30-40%，可能影响模型训练
- **市值漂移**：静态股票池中的股票可能在回测期间市值增长超过阈值，需要策略层的 `max_circ_mv` 作为安全网
- **流动性风险**：部分中小盘股流动性差，回测中的成交假设可能过于乐观
- **回测基准**：benchmark 需要从 CSI300 改为 CSI500 或 CSI1000，更匹配中小盘策略
- **兼容性**：修改 instruments 后，之前的 SOTA 因子库可能需要重新评估

## 9. 关键参数参考

| 参数 | 建议值 | 说明 |
|------|--------|------|
| `max_circ_mv` | 1,000,000（万元） | 100 亿流通市值上限 |
| `min_ratio` | 0.8 | 股票池筛选：至少 80% 交易日满足市值条件 |
| `benchmark` | CSI500 或 CSI1000 | 中小盘策略的回测基准 |
| `topk` | 50 | 持仓股票数量（可根据中小盘流动性调整） |
| `account` | 100,000,000 | 回测账户（1 亿，匹配中小盘容量） |
