# 执行10个Loop因子演进 + 10个Loop模型演进的具体步骤和命令

## 实施日期
2026-01-14

## 1. 方案概述

根据RD-Agent的架构，有两种方式可以实现"先执行10个loop的因子演进，再执行10个loop的模型演进"：

- **方案1**：使用 `fin_quant` 命令（推荐）
- **方案2**：分别使用 `fin_factor` 和 `fin_model` 命令

## 2. 方案1：使用 fin_quant 命令（推荐）

### 2.1 命令格式

```bash
rdagent fin_quant --loop_n 20
```

### 2.2 原理说明

`fin_quant` 是**因子和模型联合演进**的场景，它会自动交替执行因子和模型的演进：

- Loop 1: 因子演进
- Loop 2: 模型演进
- Loop 3: 因子演进
- Loop 4: 模型演进
- ...
- Loop 19: 因子演进
- Loop 20: 模型演进

这样，执行20个loop就会得到：
- 10个loop的因子演进（Loop 1, 3, 5, 7, 9, 11, 13, 15, 17, 19）
- 10个loop的模型演进（Loop 2, 4, 6, 8, 10, 12, 14, 16, 18, 20）

### 2.3 优势

✅ **优点：**
- 一个命令完成整个流程
- 自动协调因子和模型的演进
- 模型演进可以使用因子演进生成的SOTA因子
- 无需手动配置

❌ **缺点：**
- 无法精确控制先执行10个因子loop，再执行10个模型loop
- 因子和模型是交替进行的

### 2.4 执行步骤

**步骤1：准备环境**

```bash
# 激活conda环境
conda activate rdagent

# 确保环境变量已配置
cat .env
```

**步骤2：执行命令**

```bash
# 执行20个loop的因子和模型联合演进
rdagent fin_quant --loop_n 20
```

**步骤3：监控执行**

```bash
# 查看实时日志
rdagent ui --port 19899 --log-dir log/

# 或者在另一个终端查看日志文件
tail -f log/latest.log
```

**步骤4：查看结果**

```bash
# 查看生成的workspace
ls -la git_ignore_folder/RD-Agent_workspace/

# 查看实验结果
ls -la log/
```

## 3. 方案2：分别使用 fin_factor 和 fin_model 命令

### 3.1 命令格式

```bash
# 第一步：执行10个loop的因子演进
rdagent fin_factor --loop_n 10

# 第二步：执行10个loop的模型演进
rdagent fin_model --loop_n 10
```

### 3.2 原理说明

`fin_factor` 和 `fin_model` 是两个独立的场景：

- `fin_factor`：只执行因子演进
- `fin_model`：只执行模型演进

但是，这里有一个关键问题：**`fin_model` 无法直接使用 `fin_factor` 生成的SOTA因子**。

### 3.3 问题分析

**问题：**
- `fin_factor` 生成的SOTA因子保存在workspace中
- `fin_model` 无法直接访问 `fin_factor` 的workspace
- `fin_model` 会从Alpha158因子开始，而不是从SOTA因子开始

**解决方案：**

根据之前的分析文档（从Workspace恢复任务执行方案分析_2026-01-14.md），需要修改代码才能实现从workspace加载SOTA因子。

### 3.4 执行步骤

**步骤1：准备环境**

```bash
# 激活conda环境
conda activate rdagent

# 确保环境变量已配置
cat .env
```

**步骤2：执行10个loop的因子演进**

```bash
# 执行10个loop的因子演进
rdagent fin_factor --loop_n 10
```

**步骤3：记录因子演进的workspace路径**

```bash
# 查看最新的workspace
ls -lt git_ignore_folder/RD-Agent_workspace/ | head -n 2

# 记录workspace路径，例如：
# git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea
```

**步骤4：执行10个loop的模型演进（不使用SOTA因子）**

```bash
# 执行10个loop的模型演进（从Alpha158因子开始）
rdagent fin_model --loop_n 10
```

**注意：**
- 这个方案中，`fin_model` 不会使用 `fin_factor` 生成的SOTA因子
- `fin_model` 会从Alpha158因子开始

### 3.5 如果需要使用SOTA因子

如果需要 `fin_model` 使用 `fin_factor` 生成的SOTA因子，需要修改代码。

**修改步骤：**

1. **修改 `model_runner.py`**

在 `@/f:/Dev/RD-Agent-main/rdagent/scenarios/qlib/developer/model_runner.py` 的 `develop` 方法中添加从workspace加载SOTA因子的逻辑：

```python
def develop(self, exp: QlibModelExperiment) -> QlibModelExperiment:
    # 从workspace加载SOTA因子
    load_sota_from_workspace = os.getenv("LOAD_SOTA_FROM_WORKSPACE", "false") == "true"
    if load_sota_from_workspace:
        sota_workspace_path = Path(os.getenv("SOTA_WORKSPACE_PATH", ""))
        if sota_workspace_path.exists():
            sota_factors_path = sota_workspace_path / "combined_factors_df.parquet"
            if sota_factors_path.exists():
                SOTA_factor = pd.read_parquet(sota_factors_path, engine="pyarrow")
                logger.info(f"SOTA factors loaded from workspace: {sota_factors_path}")
                
                # 创建based_experiments
                sota_factor_exp = QlibFactorExperiment(sub_tasks=[])
                sota_factor_exp.result = {"IC": 0.0}
                exp.based_experiments = [sota_factor_exp]
    
    # ... 现有代码 ...
```

2. **配置环境变量**

```bash
# 设置环境变量
export LOAD_SOTA_FROM_WORKSPACE=true
export SOTA_WORKSPACE_PATH=./git_ignore_folder/RD-Agent_workspace/003d196d545d4039a12575789864e1ea
export USE_ALPHA_FACTORS=true
```

3. **执行模型演进**

```bash
# 执行10个loop的模型演进（使用SOTA因子）
rdagent fin_model --loop_n 10
```

## 4. 推荐方案

### 4.1 推荐使用方案1

**推荐理由：**

1. ✅ **简单易用**：一个命令完成整个流程
2. ✅ **自动协调**：自动协调因子和模型的演进
3. ✅ **无需修改代码**：不需要修改任何代码
4. ✅ **SOTA因子可用**：模型演进可以使用因子演进生成的SOTA因子

**执行命令：**

```bash
rdagent fin_quant --loop_n 20
```

### 4.2 方案对比

| 特性 | 方案1：fin_quant | 方案2：fin_factor + fin_model |
|-----|-----------------|------------------------------|
| 命令数量 | 1个 | 2个 |
| 是否需要修改代码 | ❌ 不需要 | ✅ 需要（如果要使用SOTA因子） |
| SOTA因子可用性 | ✅ 可用 | ❌ 不可用（除非修改代码） |
| 执行方式 | 交替执行 | 分别执行 |
| 推荐度 | ⭐⭐⭐⭐⭐ | ⭐⭐ |

## 5. 详细执行步骤（推荐方案1）

### 5.1 准备阶段

**步骤1：检查环境**

```bash
# 检查Python环境
python --version

# 检查RD-Agent是否安装
pip show rdagent

# 检查环境变量
cat .env
```

**步骤2：检查配置**

```bash
# 检查数据目录
ls -la data/

# 检查日志目录
ls -la log/

# 检查workspace目录
ls -la git_ignore_folder/RD-Agent_workspace/
```

### 5.2 执行阶段

**步骤3：执行命令**

```bash
# 执行20个loop的因子和模型联合演进
rdagent fin_quant --loop_n 20
```

**参数说明：**
- `--loop_n 20`：执行20个loop（10个因子loop + 10个模型loop）

**步骤4：监控执行**

```bash
# 在另一个终端启动UI监控
rdagent ui --port 19899 --log-dir log/

# 或查看日志文件
tail -f log/latest.log
```

**步骤5：检查进度**

通过UI界面可以看到：
- 当前执行的loop编号
- 当前执行的是因子还是模型
- 每个loop的性能指标
- SOTA因子的变化

### 5.3 结果查看阶段

**步骤6：查看生成的workspace**

```bash
# 查看所有workspace
ls -la git_ignore_folder/RD-Agent_workspace/

# 查看最新的workspace
ls -lt git_ignore_folder/RD-Agent_workspace/ | head -n 2
```

**步骤7：查看实验结果**

```bash
# 查看日志目录
ls -la log/

# 查看最新的实验结果
cat log/latest.log | grep "IC"

# 查看SOTA因子
cat log/latest.log | grep "SOTA"
```

**步骤8：分析结果**

```bash
# 使用RD-Agent提供的分析工具
python analyze_backtest_result.py --log-dir log/

# 或使用自定义分析脚本
python your_analysis_script.py
```

## 6. 执行时间估计

### 6.1 单个loop的时间

- **因子loop**：约30-60分钟
- **模型loop**：约20-40分钟

### 6.2 总时间估计

**方案1：fin_quant --loop_n 20**

- 10个因子loop：5-10小时
- 10个模型loop：3.3-6.7小时
- **总时间：8.3-16.7小时**

**方案2：fin_factor --loop_n 10 + fin_model --loop_n 10**

- 10个因子loop：5-10小时
- 10个模型loop：3.3-6.7小时
- **总时间：8.3-16.7小时**

### 6.3 影响因素

- 数据集大小
- 模型复杂度
- LLM响应速度
- 并行度设置
- 硬件配置

## 7. 常见问题

### 7.1 如何中断执行？

```bash
# 使用Ctrl+C中断执行
# RD-Agent会保存当前状态到session
```

### 7.2 如何继续执行？

```bash
# 从最新的session继续执行
rdagent fin_quant $LOG_PATH/__session__ --loop_n 5
```

### 7.3 如何查看执行进度？

```bash
# 启动UI监控
rdagent ui --port 19899 --log-dir log/

# 或查看日志
tail -f log/latest.log
```

### 7.4 如何调整并行度？

```bash
# 设置环境变量
export MAX_PARALLEL=2

# 然后执行命令
rdagent fin_quant --loop_n 20
```

### 7.5 如何设置时间限制？

```bash
# 设置最大执行时间
rdagent fin_quant --loop_n 20 --all_duration "12h"
```

## 8. 高级配置

### 8.1 环境变量配置

```bash
# 在.env文件中添加以下配置

# LLM配置
CHAT_MODEL=gpt-4o
OPENAI_API_KEY=your_api_key
OPENAI_API_BASE=your_api_base

# 并行度配置
MAX_PARALLEL=2

# 时间限制
MAX_DURATION=12h

# Workspace配置
WORKSPACE_PATH=./git_ignore_folder/RD-Agent_workspace

# 日志配置
LOG_PATH=./log
```

### 8.2 自定义配置

如果需要自定义配置，可以修改 `@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/conf.py` 中的配置：

```python
class QuantBasePropSetting(BasePropSetting):
    evolving_n: int = 20  # 修改默认的演进次数
    # ... 其他配置
```

### 8.3 使用不同的模型

```bash
# 设置环境变量使用不同的模型
export CHAT_MODEL=gpt-4-turbo

# 然后执行命令
rdagent fin_quant --loop_n 20
```

## 9. 总结

### 9.1 推荐方案

**推荐使用方案1：**

```bash
rdagent fin_quant --loop_n 20
```

**理由：**
- 简单易用，一个命令完成
- 自动协调因子和模型的演进
- 无需修改代码
- SOTA因子自动可用

### 9.2 执行流程

1. **准备环境**：检查Python、RD-Agent、环境变量
2. **执行命令**：`rdagent fin_quant --loop_n 20`
3. **监控执行**：使用UI或日志监控进度
4. **查看结果**：分析workspace和实验结果

### 9.3 预期效果

- 执行10个loop的因子演进
- 执行10个loop的模型演进
- 生成SOTA因子和SOTA模型
- 总时间约8.3-16.7小时

### 9.4 注意事项

- 确保环境变量正确配置
- 确保有足够的磁盘空间
- 确保有足够的内存
- 监控执行进度，及时处理错误
- 定期备份workspace和日志

## 10. 附录

### 10.1 相关文档

- 从Workspace恢复任务执行方案分析_2026-01-14.md
- RD-Agent任务启动命令和参数分析报告_2026-01-14.md
- RD-Agent量化交易框架深度分析报告.md

### 10.2 相关代码文件

- `@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/quant.py`
- `@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/factor.py`
- `@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/model.py`
- `@/f:/Dev/RD-Agent-main/rdagent/app/qlib_rd_loop/conf.py`

### 10.3 版本历史

| 版本 | 日期 | 说明 |
|-----|------|------|
| v1.0 | 2026-01-14 | 初始版本，提供执行10个loop因子演进+10个loop模型演进的具体步骤和命令 |
