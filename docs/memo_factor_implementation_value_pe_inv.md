# 因子实现备忘录：value_pe_inv 使用规范与一致性风险

## 1. 关键问题（必须修正）

当前因子实现存在核心逻辑错误：**代码未直接使用预计算的 `value_pe_inv` 列，而是自行计算**，导致与因子定义/数据规范不一致。

根据数据规范：

- `static_factors.parquet` 中已存在预计算的 `value_pe_inv` 列
- 上游已处理分母为 0 / 缺失等情况
- 因子实现应直接依赖该列，避免在 `factor.py` 内重复计算

否则会导致：

- 产出的 `value_pe_inv` 与静态因子表口径不一致
- 影响模型训练与评估的可复现性
- 引入隐性数据质量问题（尤其是负 PE、0 PE、缺失值处理）


## 2. 当前实现的问题点

- **未优先使用 `db_pe_ttm`**：仅使用 `db_pe`，与预计算逻辑不一致
- **对负市盈率处理不足**：仅把 `<=0` 设为 NaN，但负市盈率的倒数在语义上通常无意义（应当明确禁止/置 NaN）
- **可能与预计算列不一致**：自行计算会产生与上游 `value_pe_inv` 不一致的值，影响训练数据一致性


## 3. 建议修改（推荐策略）

- **直接读取 `value_pe_inv`**：
  - 若 `value_pe_inv` 缺失：
    - 推荐：输出全 NaN 并给出明确错误信息/警告（便于排查数据源）
    - 或：直接报错（如果该因子强依赖估值口径，且缺失视为不可接受）
- **禁止自行计算 `value_pe_inv`**（除非有明确的版本化口径说明，并同步更新 schema 语义与数据治理规则）


## 4. 其他反馈

- 波动率计算、输出格式（`result.h5`、索引 MultiIndex、列名等）均符合要求
- 但 **核心逻辑错误会导致因子不准确**，属于必须优先修复项


## 5. 待确认的业务口径问题（需要明确规则）

- **目前是否仍要求优先使用预计算因子？**
  - 建议：是。优先依赖 `static_factors.parquet` 中的预计算列，保证口径统一、可追溯。

- **市盈率可能为负数时是否允许？**
  - 建议：不允许参与倒数估值因子。
  - 推荐规则：`pe_ttm <= 0`（包含负数/0） => `value_pe_inv = NaN`。

（若业务上希望“保留负 PE 的信息”，建议单独设计新字段/新因子，如 `value_pe_sign`、`value_pe_abs_inv` 等，并在 schema 里明确解释，避免混用。）
