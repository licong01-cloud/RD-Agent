# AIstock ↔ RD-Agent 集成快速规范（草案）

> 版本：v0.1  
> 作用：为 LLM / RAG 提供一份精炼的系统级“硬规则”，在生成因子、模型和策略配置时必须优先遵守。

---

## 1. 数据路径与数据源分工

### 1.1 Qlib bin（回测数据）

- 当前用于回测和模型训练的 Qlib bin 目录：
  - `C:/Users/lc999/NewAIstock/AIstock/qlib_bin/qlib_bin_20251209`
  - 在 WSL 中对应：`/mnt/c/Users/lc999/NewAIstock/AIstock/qlib_bin/qlib_bin_20251209`
- 用途：
  - 被 Qlib 用作标准行情数据源，用于 RD-Agent 的因子回测和模型训练（所有 `conf_*.yaml` 中的 `provider_uri` 都指向这里）。

### 1.2 HDF5 快照（因子研发数据）

- 当前用于 CoSTEER 因子研发的数据快照目录：
  - `C:/Users/lc999/NewAIstock/AIstock/qlib_snapshots/qlib_export_20251209`
  - 在 WSL 中通过 `.env` 暴露：
    - `QLIB_DATA_PATH=/mnt/c/Users/lc999/NewAIstock/AIstock/qlib_snapshots/qlib_export_20251209`
    - `FACTOR_CoSTEER_data_folder=/mnt/c/Users/lc999/NewAIstock/AIstock/qlib_snapshots/qlib_export_20251209`
- 该目录下的 `daily_pv.h5` 是因子实现读取的核心文件。

### 1.3 股票池与过滤（非常重要）

- Qlib bin 与 HDF5 快照在导出阶段已经对齐，**使用完全一致的可交易股票池**：
  - 剔除所有 **ST / *ST 股票**；
  - 剔除所有 **已退市** 或 **当前暂停上市** 的股票；
  - 仅保留正常交易的 A 股股票（沪深主板 + 中小板 + 创业板等）。
- 在因子实现和策略描述中，默认 **无需再次按 ST/退市状态过滤** 股票，但可以在策略层面对行业/市值/流动性做进一步筛选。

---

## 2. 市场、时间区间与分段

### 2.1 市场与 benchmark

- Qlib YAML 模板中的市场相关设置：
  - `market: all`（统一使用 AIstock 集成后的 `all` 股票池配置）；
  - `benchmark: SH000300` 或 `SH000905`（具体由 YAML 模板决定）。
- 回测策略一般为 **A 股多股票组合的 long-only 选股策略**。

### 2.2 时间范围（数据可用期）

- 统一使用长周期数据：
  - `start_time: 2010-01-07`
  - `end_time: 2025-12-01`
- 训练/验证/测试分段示例（不同模板略有差异，但均在上述区间内）：
  - `train: [2010-01-07, 2018-12-31]`
  - `valid: [2019-01-01, 2020-12-31]`
  - `test:  [2021-01-01, 2025-12-01]`

### 2.3 回测结束时间（安全边界）

- 为避免 Qlib 在最后一个交易日出现 `calendar_index+1` 越界问题，回测 `end_time` 通常略早于数据末日，例如：
  - `backtest.end_time: 2025-11-28`

---

## 3. 策略目标与风险约束（当前 AIstock 演示场景）

> 这些约束在 `rdagent/scenarios/qlib/prompts.yaml` 中已经以自然语言形式写入，是 LLM 生成策略和因子时必须牢记的“业务目标”。

- **策略形态**：A 股多股票 long-only 选股策略，日频调仓。
- **组合构建**：
  - 每个调仓日，从可选股票池中选出固定数量（例如 30 只）股票，构建等权多头组合；
  - 不允许融券或杠杆（无 short / leverage）。
- **持仓与交易规则**：
  - 持仓周期：约 5–20 个交易日，可结合止盈/止损提前/延后一点；
  - 单笔止盈：浮盈 ≥ +10% 可以/应当卖出；
  - 单笔止损：浮亏 ≤ -10% 必须止损。
- **绩效目标**：
  - 长期回测期内，组合 **年化收益率** 希望 >10%；
  - 组合 **最大回撤（max drawdown）** 尽量 ≤10%（约束优先级高于收益）。

LLM 在生成因子/模型/策略建议时，应尽量：

- 不违背这些硬约束（例如给出高换手但没有任何回撤控制的策略需要明确说明风险极高）；
- 在结果分析中，主动对照这些目标解释当前策略表现好/坏的原因。

---

## 4. 技术约束与实现风格（简要）

### 4.1 LLM 调用与响应格式

- RD-Agent 通过 LiteLLM 后端调用 LLM 模型（当前主要是 DeepSeek）。
- 对于要求 JSON 输出的任务，应严格遵守 prompts 中给定的 JSON Schema：
  - 不添加额外自然语言；
  - 字段名、布尔值、数值类型需符合要求。

### 4.2 代码实现的统一约束

- 因子实现、模型代码生成时，应遵守：
  - 不导入环境中未保证存在的第三方库（例如额外的 DL 框架、数据库驱动）。
  - 不使用 `h5py`，仅通过 `pandas.DataFrame.to_hdf` 读写 HDF5。
  - 不用大范围包裹主逻辑的 `try/except`，让错误自然抛出。
  - 严格遵守项目中对 `daily_pv.h5` 结构、列名和输出 `result.h5` 的约定（详见另一份《Qlib 场景与 CoSTEER 因子实现规范》文档）。

---

## 5. RAG 检索优先级建议

当 RAG 为 LLM 提供上下文时，**本快速规范文档应被视为最高优先级**，即：

1. 当外部量化文献与本规范冲突时，以本规范为准；
2. 当 RD-Agent 官方文档细节与本规范存在版本差异时，以 AIstock 本地配置（此文档）为准；
3. 其他所有文档（量化研究文章、博客等）仅作为补充知识，不得改变数据路径、时间段、过滤规则等硬约束。
