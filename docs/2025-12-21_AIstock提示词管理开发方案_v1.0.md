# 2025-12-21 AIstock 提示词管理开发方案 v1.0

本方案用于在 AIstock（FastAPI + 前端 + DB）侧实现 **RD-Agent 提示词（prompts）多版本管理**，并支持：

- Windsurf 侧准备一套“全量提示词文件集合”（不考虑单文件替换），放到固定目录
- AIstock 侧从该目录 **直接读取并导入 DB**，作为“预制模板（Prompt Pack）”之一
- AIstock 侧支持在线编辑、对比（diff）、发布（publish）、回滚（set active）
- 初期不依赖 LLM 自动写入提示词：LLM 只允许生成“建议 diff/patch”，由人工审核后落库
- AIstock 侧可将某个 Pack 导出为“只读缓存包”（方案 A），供 RD-Agent 运行时加载，实现 **Global 一键替换全部提示词**
- 未来可平滑迁移到 RD-Agent 运行时直连 DB（方案 B）

> 约束：
> - 仅 Global 生效：系统同一时刻只有一个 Active Pack
> - pack 内必须是“全量提示词文件集合”，禁止只替换单个文件

---

## 本期开发范围（v1.0）

本期仅在 **AIstock 侧**落地“提示词模板管理”的最小闭环（Phase 0）：

- 目标：完成 **导入 -> 版本化 -> diff -> publish -> set-active** 的管理闭环
- 不在本期内：
  - 不修改 RD-Agent 代码
  - 不要求 RD-Agent 运行时从 AIstock 加载提示词（缓存包/直连 DB 均延期）
  - LLM 仅作为未来增强项，不作为本期交付必需

前端信息架构要求（本期必须满足）：

- 左侧导航栏新增一级目录：`RD-Agent管理`
- 本期功能位于二级目录：`RD-agent提示词模板管理`

---

## 0. 路线图与职责边界（从现状到完整实现）

本章节用于回答：

- **从当前状态开始**，如何分阶段实现“AIstock 全面提示词管理”
- 每个阶段的**目标**、**本阶段实施内容**、**验收标准**
- 为进入下一阶段需要提前做的**准备工作**
- 明确哪些开发工作属于 **AIstock 侧**、**RD-Agent 侧**、**Windsurf 侧**

### 0.1 责任矩阵（Ownership Matrix）

| 模块 | 责任方 | 说明 |
|---|---|---|
| Prompt Pack 数据模型与版本状态（draft/candidate/published/archived） | AIstock | DB 表设计、状态流转约束、审计字段；active 不可原地编辑 |
| 固定目录输入规范（meta.yaml + files/）与生成 | Windsurf | 产出全量 Pack 目录；保证文件清单完整 |
| 从目录导入 DB（import-from-dir） | AIstock | 读取固定目录、校验、入库、落为预制模板 |
| Pack 在线编辑、diff、发布、切换 active、回滚 | AIstock | 前端 + FastAPI + DB |
| 只读缓存包生成（active -> json）与分发 | AIstock | 从 DB 生成缓存包并放到共享卷/对象存储 |
| 运行时加载提示词（source=cache） | RD-Agent | 在模板加载入口实现 cache source；严格缺失报错 |
| 运行时覆盖机制（app_tpl） | RD-Agent | 现有能力；本方案只复用“入口集中”这一点 |
| LLM 辅助（仅输出建议 diff，不直接落库） | AIstock | 受控生成 + diff 审核 + 校验；避免误写 |
| 发布前质量门禁（YAML/Jinja/smoke test） | AIstock | 作为 publish 的阻断条件或告警 |

### 0.2 分阶段路线图（Phases）

#### Phase 0（当前阶段）：导入/版本化/发布/全局切换的最小闭环

- **目标**：
  - AIstock 能把 Windsurf 的“全量提示词目录”导入 DB，形成可发布的 Pack
  - 能 publish 并设为 global active
- **AIstock 侧实施内容**：
  - DB：`prompt_pack` / `prompt_pack_file` / `prompt_global_active`
  - 后端：`import-from-dir`、list/get、diff（最小）、publish、set-active
  - 前端：pack 列表/详情、导入、diff、publish、set-active
  - 质量门禁：YAML parse + allowlist 全量性（publish 阶段强制）
- **Windsurf 侧实施内容**：
  - 固定目录产出规范（meta.yaml + files/ 全量文件）
- **RD-Agent 侧实施内容**：
  - 本期不改动 RD-Agent；允许仍使用仓库内 prompts（此时只是“管理侧”闭环）
- **验收标准**：
  - 能成功导入至少 1 个 Pack（全量）
  - 能完成 publish 并 set-active
  - diff 能看出两个 pack 的文件差异（哪怕是粗粒度）
- **为 Phase 1 的准备**：
  - 固化 allowlist 的来源与维护机制（至少先人工维护一份）
  - 定义缓存包存储位置（共享卷/对象存储）与访问权限

#### Phase 1：与 RD-Agent 打通（方案 A：cache source）实现“全局一键替换全部提示词”

> 说明：本阶段为后续规划，**不在本期交付范围内**。

- **目标**：
  - RD-Agent 运行时从 AIstock 生成的只读缓存包加载 prompts
  - 切换 active pack 即等价于“全量替换所有提示词”（配合重启/热加载策略）
- **AIstock 侧实施内容**：
  - `set-active` 后生成缓存包 `prompt_cache/{active_pack_id}.json`
  - 缓存包结构固定：`{ pack_id, generated_at, files{rel_path: content}, checksum }`
- **RD-Agent 侧实施内容**：
  - 在 `load_content()` 增加 `RD_AGENT_PROMPT_SOURCE=cache` 的读取逻辑
  - 增加 `RD_AGENT_PROMPT_CACHE_PATH` 指向缓存包
  - 严格模式：缺文件/缺 key 直接报错
  - 打印/记录 `pack_id`（便于排障）
- **验收标准**：
  - 设置 env 后，RD-Agent 确实使用缓存包内容（可通过修改某段 prompt 验证行为变化）
  - 缺失 rel_path 时能 fail-fast（避免混用默认文件）
- **为 Phase 2 的准备**：
  - publish 阶段加入更强的质量门禁（Jinja 渲染 smoke test、required keys）
  - 预留 `RD_AGENT_PROMPT_SOURCE=db` 开关但不启用（为未来平滑迁移）

#### Phase 2：在线编辑增强 + 发布门禁完善 + LLM “建议 diff”流程

> 说明：本阶段为后续规划，**不在本期交付范围内**。

- **目标**：
  - AIstock UI 支持更强的在线编辑体验（文件树 + YAML 编辑器）
  - 引入发布门禁，降低线上切换风险
  - LLM 仅输出“建议 diff/patch”，不直接写入；人工确认后落库
- **AIstock 侧实施内容**：
  - 编辑器：支持单文件编辑、保存、版本差异对比
  - LLM 辅助：两段式（定位 targets -> 生成 diff），UI 展示 diff + 人审确认
  - 发布门禁：
    - YAML parse
    - allowlist 全量性
    - （建议）Jinja 渲染 smoke test（至少覆盖关键 prompt key）
- **RD-Agent 侧实施内容**：
  - 无新增必须项（仍用 cache source）
- **验收标准**：
  - UI 上能完整编辑 pack 并发布
  - publish 会阻断明显错误（YAML/Jinja）
  - LLM 辅助不会绕过人工确认
- **为未来 Phase 3 的准备**：
  - 设计 pack 的不可变策略：published pack 禁止原地编辑，必须转为 candidate 后再编辑
  - 预留 `RD_AGENT_PROMPT_SOURCE=db` 开关但不启用（为未来平滑迁移）

#### Phase 3（可选，未来）：从 cache 平滑迁移到直连 DB（方案 B）

> 说明：本阶段为后续规划，**不在本期交付范围内**。

- **目标**：
  - RD-Agent 运行时直接从 DB 或 Prompts API 读取（不依赖缓存包）
- **AIstock 侧准备**：
  - 若走 API：提供稳定的只读 Prompts Resolver API（强缓存 + 高可用）
  - 若 RD-Agent 直连 DB：提供连接参数与访问策略
- **RD-Agent 侧实施内容**：
  - 增加 `RD_AGENT_PROMPT_SOURCE=db`，实现 DB/API source
  - 保持 rel_path 与 pack 结构一致，实现无痛切换

---

## 1. 背景与目标

RD-Agent 项目中广泛使用 `T(".prompts:xxx").r()` 渲染提示词。其加载入口集中在：

- `rdagent/utils/agent/tpl.py` 的 `load_content()`

并且已有“覆盖机制”：

- `RD_AGENT_SETTINGS.app_tpl` 可让应用用文件目录覆盖默认模板

该机制证明：

- 模板解析与渲染入口集中，可通过“更高优先级的 source”实现全局替换

但 `app_tpl` 是文件系统覆盖，不具备 DB 多版本/审计/在线编辑能力。

本方案在 AIstock 侧建立 Prompt Pack 管理能力，并通过“缓存包分发（方案 A）”让 RD-Agent 运行时无感切换。

---

## 2. 核心概念

### 2.1 Prompt Pack（全量提示词版本包）

- 一个 Prompt Pack 代表某一时刻/某一场景下的 **全量提示词文件集合**
- 包含：
  - 元信息（时间、简介、来源等）
  - 全量文件（按仓库相对路径保存的 `prompts.yaml` 等）

### 2.2 预制模板（Preset Pack）

- 从 Windsurf 固定目录导入的 Pack，作为 AIstock 内置/预制模板
- 允许被克隆为 draft 后再编辑发布

### 2.3 Active Pack（全局生效）

- 系统只有一个 Active Pack
- RD-Agent 所有任务默认使用该 Pack

### 2.4 状态机（draft / candidate / published / archived）

为保证“线上使用版本可控且可追溯”，建议采用以下状态机：

- `draft`：可编辑草稿版本；可反复修改；不可被 set-active
- `candidate`：待发布版本；用于承载“从已发布版本编辑后”的变更；需要通过校验与人工确认后才能 publish
- `published`：已发布版本；内容只允许在“转为 candidate”后再编辑；可被 set-active
- `archived`：历史保留版本；不可 set-active；允许被“恢复为 candidate”后再校验发布

核心约束：

- **active pack 禁止原地编辑**：任何修改必须基于其内容 fork/clone 出新 pack（draft/candidate）后再修改
- **编辑已发布版本会触发再发布流程**：非 active 的 `published` pack 若发生编辑保存，则其 `status` 自动变为 `candidate`
- **archived 可恢复**：`archived -> candidate` 允许（恢复后需重新校验/确认，再 publish）

### 2.5 状态流转规则（可执行版）

本小节定义后端必须实现的“允许/禁止”条件，避免 UI 与后端各自理解不一致。

允许的状态流转：

- `draft -> candidate`
  - 触发：
    - 显式点击“提交发布/进入候选（mark-candidate）”
    - 或编辑非 active 的 `published/archived` 后第一次保存时自动转入 `candidate`
- `candidate -> published`
  - 触发：点击 publish
  - 约束：必须通过 publish gate（见 8.1）
- `published -> archived`
  - 触发：归档
  - 约束：active pack 禁止归档
- `archived -> candidate`
  - 触发：恢复为候选版本
  - 约束：恢复后必须重新走 publish gate 才能变为 published

禁止/拒绝规则：

- 若 `pack_id == active_pack_id`：
  - 禁止：
    - 原地编辑（任何写入文件内容）
    - 归档
    - 直接 mark-candidate（建议要求先 fork/clone）
- 禁止 `draft -> published` 直接发布（推荐）
  - v1.0 可以保留兼容，但建议后端统一：先 `draft -> candidate` 再 `candidate -> published`
- 禁止对 `archived` 直接 publish
  - 必须先 `archived -> candidate`，并重新校验

---

## 3. Windsurf 侧准备规范（固定目录导入）

**[责任方：Windsurf]**

### 3.1 固定目录结构（推荐）

Windsurf 输出到固定目录（例如：`/data/aistock/prompt_packs_inbox/`），每个 pack 一个子目录：

- `<inbox>/<pack_id>/`
  - `meta.yaml`
  - `files/`
    - `rdagent/utils/prompts.yaml`
    - `rdagent/components/proposal/prompts.yaml`
    - `rdagent/scenarios/qlib/prompts.yaml`
    - `rdagent/scenarios/qlib/experiment/prompts.yaml`
    - `...`（必须包含 AIstock 维护的“提示词文件清单”的全部文件）

### 3.2 meta.yaml 字段（最小集合）

- `id`: string（与目录名一致）
- `created_at`: ISO8601
- `description`: string
- `source`: string（例如 `windsurf`）
- `source_version`: string（可选）
- `source_commit`: string（可选）
- `tags`: list[string]（可选）

### 3.3 全量性约束

- AIstock 维护一份“RD-Agent prompts 文件清单（allowlist）”
- 导入时 pack 必须包含 allowlist 的全部文件，否则导入失败或仅允许进入 draft 且不可 publish

allowlist 来源建议：

- 初期直接使用 `docs/2025-12-20提示词汇总.md` 中列出的提示词文件集合（由研发维护）
- 中期可在 RD-Agent 仓库通过脚本扫描生成（以 `T("...prompts...")` 引用与 `prompts.yaml` 文件路径为准）

---

## 4. AIstock 侧 DB 设计（v1.0 最小闭环）

**[责任方：AIstock]**

### 4.1 表：prompt_pack

- `id` (PK)
- `created_at`
- `updated_at`
- `description`
- `usage_scene`（使用场景说明，面向业务/运营/研发）
- `requirements`（使用要求，例如需要哪些运行条件/依赖）
- `limitations`（限制/风险/不适用范围）
- `tags` (json)
- `source` (e.g. windsurf/manual)
- `status` (draft/candidate/published/archived)
- `created_by` (optional)
- `base_pack_id` (optional)
- `checksum` (optional)

### 4.2 表：prompt_pack_file

- `pack_id` (FK)
- `rel_path`（例如 `rdagent/scenarios/qlib/experiment/prompts.yaml`）
- `content` (longtext)
- `content_hash` (optional)
- `updated_at`
- unique(`pack_id`, `rel_path`)

### 4.3 表：prompt_global_active

- `active_pack_id`
- `updated_at`
- `updated_by`

### 4.4 表：prompt_pack_event（审计事件表，强烈建议）

目的：对“谁在什么时间做了什么操作、为什么”留痕，可直接用于发布说明/回滚排查。

- `id` (PK)
- `pack_id` (FK)
- `created_at`
- `actor`（用户名/用户 id）
- `event_type`（enum，建议：import/clone/edit/mark_candidate/publish/archive/set_active/apply）
- `from_status` (nullable)
- `to_status` (nullable)
- `message`（用户填写的说明，例如 publish reason / apply reason）
- `metadata` (json)
  - 建议至少包含：
    - `base_pack_id`（若有）
    - `changed_files`（rel_path 列表，可选）
    - `diff_summary`（可选）

### 4.5 表：prompt_pack_validation_run（校验运行记录，强烈建议）

目的：publish gate 的“硬门禁”结果要可追溯，并能在 UI 展示最近一次校验报告。

- `id` (PK)
- `pack_id` (FK)
- `created_at`
- `actor`
- `trigger`（enum：import_validate/import/publish_validate/publish）
- `ok` (bool)
- `report` (json)（结构见 8.3）
- `summary` (text)（可选，便于列表页快速展示）

建议约束：

- publish 时必须写入一条 `prompt_pack_validation_run(trigger=publish)`
- publish gate 失败时也必须落库（`ok=false`），方便复现

---

## 5. AIstock 侧后端能力（FastAPI）

**[责任方：AIstock]**

### 5.1 导入（从固定目录读取）

- `POST /api/v1/prompt-packs/import-from-dir`
  - body: `{ "dir": "/data/aistock/prompt_packs_inbox/<pack_id>" }`
  - 行为：读取 `meta.yaml` + `files/**` 并写入 DB
  - 校验：
    - meta 必填字段
    - YAML parse（对每个 yaml）
    - allowlist 全量性（至少 publish 前必须满足）

补充（用于首页“目录一键导入”的预校验与导入确认流程）：

- `POST /api/v1/prompt-packs/validate-import-dir`
  - body: `{ "dir": "/data/aistock/prompt_packs_inbox/<pack_id>" }`
  - 行为：不入库，仅扫描并返回校验结果（是否存在 meta、文件数量、缺失文件、YAML 格式错误等）
  - 返回建议包含：
    - `ok`（bool）
    - `pack_id`（从 meta 推断）
    - `missing_files`（相对路径列表）
    - `extra_files`（相对路径列表）
    - `yaml_parse_errors`（按文件聚合）
    - `files_count` / `required_files_count`

- `POST /api/v1/prompt-packs/import-from-dir`
  - 首页导入时建议先调用 `validate-import-dir`，校验通过后再执行导入

补充（建议的 validate/import 返回结构，可直接按此做 Pydantic schema）：

- `ValidateImportDirResponse`：
  - `ok`: bool
  - `pack_id`: string (nullable)
  - `meta_ok`: bool
  - `required_files_count`: int
  - `files_count`: int
  - `missing_files`: list[string]
  - `extra_files`: list[string]
  - `yaml_parse_errors`: list[{ rel_path: string, error: string }]

- `ImportFromDirResponse`：
  - `pack_id`: string
  - `status`: string（建议导入后为 draft）
  - `created_at`: string

### 5.2 Pack 列表/详情

- `GET /api/v1/prompt-packs?page=1&page_size=20&status=published&query=...`
- `GET /api/v1/prompt-packs/{pack_id}`
- `GET /api/v1/prompt-packs/{pack_id}/files`
- `GET /api/v1/prompt-packs/{pack_id}/files?rel_path=...`

补充（用于 UI 顶部显示当前生效版本）：

- `GET /api/v1/prompt-packs/active`

补充（建议列表/详情字段，避免前端二次请求过多）：

- 列表项建议包含：
  - `id`、`status`、`description`、`source`、`base_pack_id`、`created_at`、`updated_at`
  - `is_active`（由后端根据 prompt_global_active 计算）
  - `latest_validation`（nullable，来自 prompt_pack_validation_run 的最近一条记录摘要）

### 5.3 编辑（draft/candidate；published/archived 需转 candidate）

- `PUT /api/v1/prompt-packs/{pack_id}/files/{rel_path}`
  - 校验 YAML parse
  - 写入 `prompt_pack_file`

编辑与状态约束（后端强制）：

- 若 `pack_id` 为当前 active：拒绝写入（返回明确错误，提示先 fork/clone）
- 允许编辑 `draft` 与 `candidate`
- 若为非 active 的 `published` 或 `archived`：
  - 可选择：
    - 显式接口将状态转为 `candidate` 后再允许写入
    - 或在第一次写入时自动把状态置为 `candidate`（并记录 `updated_at/updated_by`）

补充（推荐的“自动转 candidate”的一致行为）：

- 若目标 pack 当前为 `published` 或 `archived` 且非 active：
  - 第一次写入时：
    - 后端将 `status` 更新为 `candidate`
    - 写入 `prompt_pack_event(event_type=mark_candidate, from_status, to_status)`
    - 要求前端传入 `message`（例如“编辑 published 版本，转 candidate 原因”）

补充（v1.0 的“安全编辑器：只编辑自然语言文本，级别 A”）：

- `GET /api/v1/prompt-packs/{pack_id}/text-nodes`
  - 返回该 pack 下所有 prompts 文件的可编辑字符串节点（按文件分组）
- `PUT /api/v1/prompt-packs/{pack_id}/text-nodes`
  - 批量保存文本节点（只允许修改字符串值，禁止改 YAML 结构）

补充（建议 text-nodes 的数据结构，保证“只改字符串值不改结构”可以落地）：

- `TextNode`：
  - `rel_path`: string
  - `json_path`: string（例如 `$.qlib_factor_experiment_setting` 或更细粒度 path）
  - `key`: string（可选，展示用）
  - `value`: string

- `GET /text-nodes` 返回：
  - `pack_id`
  - `nodes`: list[TextNode]

- `PUT /text-nodes` 入参：
  - `message`（可选，审计说明）
  - `changes`: list[{ rel_path, json_path, new_value }]

后端保存步骤建议：

- 读取原 YAML -> 定位 json_path -> 仅替换 string value -> dump 回 YAML
- dump 后做 YAML parse（再次确认可解析）
- 若 pack 为 published/archived 且非 active：保存前自动转 candidate（规则见 2.5）

### 5.4 Clone（从预制/已发布派生）

- `POST /api/v1/prompt-packs/{pack_id}/clone`
  - 生成新 pack（draft），复制所有 file

补充（从 UI 的“编辑”动作派生新版本草稿）：

- `POST /api/v1/prompt-packs/{pack_id}/fork-for-edit`
  - 行为等价 clone，但会把 `base_pack_id` 设置为来源 pack

补充（状态流转接口，可选但建议具备以降低“隐式自动转状态”的歧义）：

- `POST /api/v1/prompt-packs/{pack_id}/mark-candidate`
  - 行为：将 `status` 置为 `candidate`
  - 约束：active pack 禁止；仅允许从 `published/archived/draft` 转入 `candidate`

### 5.5 Diff

- `GET /api/v1/prompt-packs/diff?from=A&to=B`
  - 返回：文件级 diff + 行级 diff（可用 difflib）

### 5.6 发布/回滚（Global）

- `POST /api/v1/prompt-packs/{pack_id}/publish`
  - 约束：仅允许 `candidate` publish（或允许 `draft` 直接 publish，但建议统一走 candidate）
  - 校验（当前阶段只做语法层面）：
    - allowlist 全量性
    - YAML parse
    - （可选）Jinja 渲染 smoke test（见 8.2）

补充（publish 入参/出参建议）：

- Request：`{ "message": "发布说明（必填）" }`
- Response：
  - `pack_id`
  - `from_status`
  - `to_status`（published）
  - `validation_run_id`

- `POST /api/v1/prompt-packs/{pack_id}/set-active`
  - 将 `prompt_global_active.active_pack_id = pack_id`

补充（set-active 约束与审计）：

- 约束：仅允许 `published` 被 set-active
- Request：`{ "message": "应用说明（必填）" }`
- 行为：
  - 写 `prompt_global_active`
  - 写 `prompt_pack_event(event_type=set_active, message=...)`

补充（用于实现“active pack 不可编辑”的前端判定与后端校验）：

- `GET /api/v1/prompt-packs/{pack_id}/can-edit`
  - 返回：`{ can_edit: bool, reason?: string, edit_mode: "fork_only" | "in_place" }`

补充（can-edit 的判断逻辑建议）：

- 若 active：`can_edit=false, edit_mode=fork_only`
- 若 status=published 且非 active：`can_edit=true, edit_mode=in_place`
- 若 status=draft/candidate：`can_edit=true, edit_mode=in_place`
- 若 status=archived：`can_edit=true, edit_mode=in_place`（但建议 UI 先引导恢复 candidate）

补充（用于 UI 的“应用”按钮二次确认，可复用 set-active，也可新增一个显式 endpoint）：

- `POST /api/v1/prompt-packs/{pack_id}/apply`
  - 与 `set-active` 等价；保留该 endpoint 只是为了语义清晰

---

## 6. 前端 UI（v1.0 页面）

**[责任方：AIstock]**

### 6.0 导航挂载位置（本期必须）

- 左侧导航栏新增一级目录：`RD-Agent管理`
- 本期功能页面挂载在二级目录：`RD-agent提示词模板管理`

说明：

- 本期仅要求实现“管理闭环”相关页面（导入/列表/详情/diff/publish/set-active）
- 在线编辑器与 LLM 辅助流程为后续增强项（Phase 2）

### 6.1 Packs 列表页

- 展示：id / created_at / description / status / 是否 active
- 展示（扩展）：usage_scene / requirements / limitations（可折叠）
- 顶部固定区域：显示当前 Active Pack（id + description + updated_at）
- 操作：
  - Import（从固定目录）
  - View
  - Clone
  - Diff vs Active
  - Publish
  - Apply（应用；published 才可；点击后弹窗二次确认）
  - Edit（编辑；点击后进入编辑页；默认进入“另存为新模板”的编辑模式）

列表页状态与操作可用性建议：

- `draft`：可 Edit、可 Publish（建议会先进入 candidate 再 publish）
- `candidate`：可 Edit、可 Publish、不可 Apply
- `published`：
  - 若非 active：可 Edit（保存后会变为 candidate）、可 Apply
  - 若为 active：不可 Edit（只能 Clone/Fork）
- `archived`：不可 Apply；可“恢复为 candidate”后再 publish

补充（按钮/权限矩阵，可直接按此实现 UI 显示与禁用态）：

| 状态 | is_active | View | Diff vs Active | Clone/Fork | Edit | Mark candidate | Publish | Apply/Set active | Archive |
|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| draft | false | Y | Y | Y | Y | Y | N（建议先 mark-candidate） | N | Y |
| candidate | false | Y | Y | Y | Y | N | Y | N | Y |
| published | false | Y | Y | Y | Y（保存转 candidate） | N | N（需先保存变 candidate） | Y | Y |
| published | true | Y | Y | Y | N（只能 fork） | N | N | Y（当前已 active，可显示为禁用或“已生效”） | N |
| archived | false | Y | Y | Y | Y（建议先恢复 candidate） | Y（restore） | Y（需先 restore candidate） | N | N |

说明：

- 表中 “Edit” 对 published(非 active) 表示允许进入原地编辑，但首次保存必须确认并转 candidate
- “Archive” 的含义是 `published -> archived`，对 `archived` 本身不再显示

分页要求：

- 默认按 `updated_at desc` 排序
- 支持分页（page/page_size）
- 支持按状态筛选（draft/candidate/published/archived）与关键字搜索（query）

### 6.2 Pack 编辑页（在线编辑）

编辑页分为三种入口：

- 从列表页点击 **Edit**：
  - 若该 pack 为 **active**：
    - 仅允许 **Fork/Clone 后编辑**（生成新 pack 并进入新 pack 的编辑页）
  - 若该 pack 为 **published 且非 active**：
    - 允许进入“原地编辑”模式，但首次保存时必须二次确认：
      - 确认后将该 pack 的 `status` 自动置为 `candidate`
      - 并记录变更摘要（可选）
  - 若该 pack 为 **archived**：
    - 需先点“恢复为 candidate”（或编辑时自动转 candidate），再进入编辑
- 从列表页点击 **Clone/Fork**：
  - 始终生成新 pack（draft/candidate），进入新 pack 编辑页

编辑模式（v1.0 选择级别 A：显示整个字符串文本，不拆分/保护模板语法）：

- 页面以“从上到下排列”的方式展示全部 prompts 文件
  - 每个文件一个 section：`rel_path`
  - 每个文件内按 YAML 顶层 key 展示多个文本编辑框（一个 key 对应一个 editor）
- 编辑框默认显示当前 pack 的该 key 文本
- 保存策略：
  - 对 active pack：仅提供 **另存为新模板**（强制 fork/clone）
  - 对非 active published/archived pack：保存时自动转为 `candidate`（需二次确认）
  - 对 draft/candidate pack：直接保存（仍需 YAML parse）

后端交互建议：

- 编辑页加载：调用 `GET /text-nodes` 一次性加载所有 editor 的默认内容
- 保存：调用 `PUT /text-nodes` 批量提交变更（只允许修改字符串值）

补充（编辑页建议加入的“发布前信息提示”）：

- 显示当前 pack：`status`、`is_active`、`base_pack_id`
- 若来源是 published/archived：保存会转 `candidate`，在保存按钮旁做明确提示
- 保存成功后自动跳转到详情页，并提示下一步：进行 publish 校验

安全约束（后端强制）：

- 只允许修改字符串值，禁止修改 YAML key/结构
- 保存时做 YAML parse
- publish 时再做更强门禁（可选 Jinja 渲染 smoke test）

### 6.3 LLM 辅助（不直接落库）

- 输入：自然语言需求
- 输出：建议修改的文件 + 建议 diff
- UI 展示 diff，用户确认后才执行“写入 draft 文件”的 API

补充（与安全编辑器配合）：

- LLM 的输出必须是“建议修改哪些 text-nodes 的新文本”或“建议 diff”
- 最终仍需人工确认后，才调用 `PUT /text-nodes` 写入 draft
- LLM 结论仅做建议，不作为 publish 的硬门禁

### 6.4 新建（Create New Pack）

页面下方提供 **New** 按钮，支持两种新建方式：

- **新建空模板**：
  - 创建一个新的 draft pack，包含 allowlist 的全部文件与 key，但所有文本内容为空（或填入占位符）
- **基于模板初始化**：
  - 从一个已发布 pack clone/fork，作为新 draft 的初始内容

说明：

- v1.0 推荐默认使用“基于模板初始化”（最不容易遗漏 key/结构）
- “新建空模板”更适合做测试/占位；publish 前必须补齐所有必要内容

### 6.5 目录一键导入（Import From Directory）

在首页底部，与 **New** 按钮并列提供 **Import** 入口，用于把“已有提示词文件一套（全量 pack 目录）”一键导入 DB。

交互流程建议：

1. 用户点击 Import
2. 弹窗/侧边栏提供目录选择（输入路径或选择器）
3. 点击“预校验”
   - 前端调用 `POST /api/prompt-packs/validate-import-dir`
   - 页面展示校验结果：
     - 是否包含 meta.yaml
     - 识别出的 pack_id
     - 文件总数/必需文件数
     - 缺失文件列表（missing_files）
     - 多余文件列表（extra_files）
     - YAML 解析错误列表（yaml_parse_errors）
4. 校验通过后，启用“确认导入”按钮
5. 点击“确认导入”后执行导入
   - 前端调用 `POST /api/prompt-packs/import-from-dir`
   - 导入成功后在列表中出现新的 pack（通常为 draft 或 published，取决于导入策略）

导入策略建议：

- v1.0 推荐导入后先标记为 `draft`，由用户检查 diff/内容后再 publish
- 若导入来源为受信任的预制目录（例如由 Windsurf 固化输出），也可以允许导入直接为 `published`（但仍建议保留人工 publish）

---

## 7. 向 RD-Agent 分发（方案 A：只读缓存包）

**[责任方：AIstock + RD-Agent]**

### 7.1 缓存包格式（建议 JSON）

**[责任方：AIstock]**

AIstock 在 `set-active` 后生成只读缓存包（可落对象存储或共享卷），例如：

- `prompt_cache/{active_pack_id}.json`

结构：

- `pack_id`
- `generated_at`
- `files`: `{ rel_path: content }`
- `checksum`

### 7.2 RD-Agent 侧加载方式（最小改动目标）

**[责任方：RD-Agent]**

RD-Agent 增加两项环境变量（建议）：

- `RD_AGENT_PROMPT_SOURCE=cache`
- `RD_AGENT_PROMPT_CACHE_PATH=/path/to/prompt_cache/<active_pack_id>.json`

并在 `load_content()` 中加入：

- 当 source=cache 时，从 cache 文件读取 `files[rel_path]` 作为内容来源
- 严格模式：找不到 rel_path 直接报错

> 说明：本方案复用现有“模板加载入口集中”的优势，尽量避免修改业务代码调用点。

---

## 8. 校验与质量控制

**[责任方：AIstock]**

### 8.1 静态校验（导入/保存/发布）

- YAML parse
- allowlist 全量性（publish 必做）
- 关键 key 存在性（可选：针对每个文件维护 required keys）

说明（当前阶段约束）：

- 当前只要求“语法层面检查”作为 publish 的硬门禁
- 逻辑一致性/风险审阅（包括 LLM 检查）作为后续增强项，仅输出建议

### 8.3 校验报告结构（Validation Report JSON，可落库）

建议 `prompt_pack_validation_run.report` 使用统一结构，便于 UI 与后端一致展示：

- `pack_id`: string
- `status_at_validate`: string
- `ok`: bool
- `checks`: list[CheckResult]

`CheckResult`：

- `name`: string（enum 建议：meta/allowlist/yaml_parse/required_keys/jinja_smoke）
- `ok`: bool
- `severity`: string（error/warn）
- `message`: string
- `details`: object（可选，按检查类型展开）

其中 `yaml_parse` 的 details 建议：

- `errors`: list[{ rel_path: string, error: string }]

其中 `allowlist` 的 details 建议：

- `required_files_count`: int
- `present_files_count`: int
- `missing_files`: list[string]
- `extra_files`: list[string]

UI 展示建议：

- 若存在任一 `checks[].severity=error && ok=false`：Publish 按钮禁用，并要求用户修复
- warn 仅提示（当前版本不做逻辑风险硬门禁）

### 8.2 Jinja 渲染 smoke test（建议）

因为 `T(...).r()` 使用 `StrictUndefined`，很容易因变量缺失导致运行时报错。

建议在 publish 前，对 allowlist 中关键模板 key 做一次渲染测试：

- 给定最小 context（例如空或常用字段），检查是否报错
- 或仅测试 `load_content` 返回是否为字符串（不渲染），在 v1.0 先做轻量版

---

## 9. 未来平滑迁移到方案 B（运行时直连 DB）

**[责任方：AIstock + RD-Agent]**

v1.0 使用方案 A（缓存包）不锁死架构。

平滑迁移前提：

- rel_path 规则固定不变
- pack_id 与文件集合保持同构
- RD-Agent 侧把“prompt 获取”抽象为可切换 source

迁移步骤：

1. RD-Agent 增加 `RD_AGENT_PROMPT_SOURCE=db`
2. 实现 DB source（或 Prompts API source）
3. 灰度切换，保持 cache 作为回退
4. 稳定后可停用 cache 生成（可选）

---

## 10. 与 RD-Agent 现有覆盖机制（app_tpl）的关系

- `app_tpl` 是文件系统覆盖：适用于“应用目录覆盖默认模板”
- 本方案是 DB 多版本管理：适用于“可审计、可编辑、可发布、可回滚”的企业级管理

复用点：

- 模板加载入口集中在 `load_content()`，因此只需在该入口增加更高优先级的 source（cache/db）即可覆盖所有 `T(...)` 调用点。

---

## 11. v1.0 交付清单（建议）

- **后端（本期：Phase 0 管理闭环）**：
  - DB 表：`prompt_pack` / `prompt_pack_file` / `prompt_global_active`（建议额外包含 event/validation_run）
  - API：import-from-dir / validate-import-dir
  - API：list/get/active
  - API：diff（最小可用）
  - API：publish + set-active

- **前端（本期：Phase 0 管理闭环）**：
  - 左侧导航：一级 `RD-Agent管理`，二级 `RD-agent提示词模板管理`
  - Pack 列表/详情
  - Import（从固定目录导入）
  - Diff（至少支持与 Active 对比）
  - Publish / Set-active（含二次确认）

- **延期（不在本期）**：
  - cache 包生成与分发（Phase 1）
  - 在线编辑器（文件树/YAML 编辑器 或 text-nodes 安全编辑器）（Phase 2）
  - LLM “建议 diff/patch” 流程（Phase 2）
  - RD-Agent 运行时支持 `RD_AGENT_PROMPT_SOURCE=cache`（Phase 1）
