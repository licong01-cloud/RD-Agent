# SOTAå› å­ç»„åˆä¼˜åŒ–æ–¹æ¡ˆï¼ˆå¤šTaskèšåˆç‰ˆï¼‰

## ğŸ“‹ æ¦‚è¿°

ä»RD-Agent**æ‰€æœ‰å†å²ä»»åŠ¡**ä¸­æå–SOTAå› å­ï¼Œè‡ªåŠ¨èšåˆã€å»é‡ï¼Œé€šè¿‡å¤šç»´åº¦ç­›é€‰å’Œæ™ºèƒ½ç»„åˆï¼Œæ‰¾å‡ºæœ€ä½³å› å­ç»„åˆå¹¶è¿›è¡Œå›æµ‹éªŒè¯ã€‚

**âœ¨ æ ¸å¿ƒæ”¹è¿›**ï¼š
- âœ… **è‡ªåŠ¨æ‰«ææ‰€æœ‰taskç›®å½•**ï¼ˆæ”¯æŒå‡ åä¸ªå†å²ä»»åŠ¡ï¼‰
- âœ… **è·¨taskæ™ºèƒ½å»é‡**ï¼ˆä»£ç +å‡è®¾ç›¸ä¼¼åº¦ï¼‰
- âœ… **æ¥æºè¿½æº¯**ï¼ˆæ¯ä¸ªå› å­æ ‡è®°æ¥æºtaskï¼‰

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. **å¤šTaskèšåˆ**
- **è‡ªåŠ¨æ‰«æ**ï¼šéå†`log/`ä¸‹æ‰€æœ‰taskç›®å½•
- **æ™ºèƒ½å»é‡**ï¼š
  - å®Œå…¨ç›¸åŒä»£ç å»é‡
  - å‡è®¾ç›¸ä¼¼åº¦å»é‡ï¼ˆé»˜è®¤é˜ˆå€¼90%ï¼‰
- **æ¥æºè¿½æº¯**ï¼šæ¯ä¸ªå› å­è®°å½•æ‰€å±task

### 2. **å¤šå±‚ç­›é€‰æœºåˆ¶**
- **ä¸šç»©æŒ‡æ ‡ç­›é€‰**ï¼šåŸºäºICã€å¹´åŒ–æ”¶ç›Šã€æœ€å¤§å›æ’¤
- **å¤šæ ·æ€§ç­›é€‰**ï¼šç¡®ä¿å› å­ç±»å‹åˆ†å¸ƒå‡è¡¡ï¼ˆåŠ¨é‡ã€æˆäº¤é‡ã€ç›¸å…³æ€§ç­‰ï¼‰
- **ç›¸å…³æ€§å»é‡**ï¼šé¿å…é«˜åº¦ç›¸å…³å› å­ï¼ˆICç›¸å…³æ€§>0.995ï¼‰

### 2. **ç»„åˆä¼˜åŒ–ç®—æ³•**
- **è´ªå¿ƒç®—æ³•**ï¼šåŸºäºç»¼åˆè¯„åˆ†ï¼ˆIC + æ”¶ç›Šï¼‰è¿­ä»£é€‰æ‹©
- **èšç±»ç®—æ³•**ï¼šK-meansèšç±»åä»æ¯ç°‡é€‰æ‹©æœ€ä¼˜å› å­
- **ICç›¸å…³æ€§çŸ©é˜µ**ï¼šè®¡ç®—å› å­é—´ç›¸å…³æ€§ï¼Œä¼˜åŒ–ç»„åˆå¤šæ ·æ€§

### 3. **è‡ªåŠ¨å›æµ‹éªŒè¯**
- å¯¼å‡ºqlibæ ¼å¼å› å­æ•°æ®
- ç”Ÿæˆæ ‡å‡†qlibå›æµ‹é…ç½®
- æ”¯æŒLightGBM/æ·±åº¦å­¦ä¹ æ¨¡å‹

---

## ï¿½ Logç›®å½•ç»“æ„

RD-Agentä¼šä¸ºæ¯æ¬¡ä»»åŠ¡åˆ›å»ºç‹¬ç«‹çš„logç›®å½•ï¼š

```
F:\Dev\RD-Agent-main\log\
â”œâ”€â”€ 2026-01-15_10-23-45-123456/    # Task 1
â”‚   â”œâ”€â”€ __session__/
â”‚   â”‚   â”œâ”€â”€ step_0.pkl             # LoopçŠ¶æ€æ•°æ®
â”‚   â”‚   â””â”€â”€ step_1.pkl
â”‚   â””â”€â”€ ...
â”œâ”€â”€ 2026-01-20_14-30-12-789012/    # Task 2
â”‚   â”œâ”€â”€ __session__/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ 2026-02-02_02-29-16-478868/    # Task 3ï¼ˆæœ€æ–°ï¼‰
â”‚   â””â”€â”€ __session__/
â””â”€â”€ ...ï¼ˆå¯èƒ½æœ‰å‡ åä¸ªtaskï¼‰
```

**å·¥å…·ä¼šè‡ªåŠ¨**ï¼š
- âœ… æ‰«ææ‰€æœ‰taskç›®å½•
- âœ… ä»æ¯ä¸ªtaskçš„`__session__/*.pkl`æå–SOTAå› å­
- âœ… èšåˆå¹¶å»é‡

---

## ï¿½ğŸš€ ä½¿ç”¨æµç¨‹

### æ­¥éª¤1ï¼šæå–SOTAå› å­ï¼ˆå¤šTaskèšåˆï¼‰

```bash
cd F:\Dev\RD-Agent-main\tools\factor_optimization
python 01_extract_and_analyze_sota_factors.py
```

**åŠŸèƒ½**ï¼š
- **è‡ªåŠ¨æ‰«ææ‰€æœ‰taskç›®å½•**ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
- æå–æ‰€æœ‰SOTAå› å­çš„ä»£ç ã€æŒ‡æ ‡ã€ç±»å‹
- **æ™ºèƒ½å»é‡**ï¼šç§»é™¤é‡å¤å’Œé«˜åº¦ç›¸ä¼¼å› å­
- ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Šå’Œå®Œæ•´æ•°æ®æ–‡ä»¶

**å¯é€‰ï¼šåªå¤„ç†å•ä¸ªtask**
```python
# ç¼–è¾‘è„šæœ¬ç¬¬253è¡Œ
extractor = SOTAFactorExtractor(log_root, aggregate_all_tasks=False)
# False = åªå¤„ç†æœ€æ–°task
# True = èšåˆæ‰€æœ‰taskï¼ˆæ¨èï¼‰
```

**è¾“å‡º**ï¼š
- `output/sota_factors_full.csv` - å› å­åˆ—è¡¨ï¼ˆä¸å«ä»£ç ï¼‰
- `output/sota_factors_full.pkl` - å®Œæ•´æ•°æ®ï¼ˆå«å®éªŒå¯¹è±¡ï¼‰

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
æ‰¾åˆ° 35 ä¸ªtaskç›®å½•

å¤„ç†task: 2026-01-15_10-23-45-123456
  æå–åˆ° 12 ä¸ªSOTAå› å­

å¤„ç†task: 2026-01-20_14-30-12-789012
  æå–åˆ° 8 ä¸ªSOTAå› å­

...ï¼ˆçœç•¥å…¶ä»–taskï¼‰

=== æ±‡æ€» ===
æ€»SOTAå› å­æ•°: 342

=== å»é‡å¤„ç† ===
å»é‡å‰: 342 ä¸ªå› å­
å®Œå…¨ç›¸åŒä»£ç å»é‡: ç§»é™¤ 23 ä¸ª
å‡è®¾ç›¸ä¼¼åº¦å»é‡: ç§»é™¤ 19 ä¸ª
å»é‡å: 300 ä¸ªå› å­

=== Taskåˆ†å¸ƒç»Ÿè®¡ ===
task_name                        å› å­æ•°  å¹³å‡IC
2026-02-02_02-29-16-478868        45    0.0421
2026-01-27_03-22-55-431124        38    0.0398
...
```

---

### æ­¥éª¤2ï¼šç­›é€‰æœ€ä¼˜å› å­ç»„åˆ

```bash
python 02_factor_selection_and_combination.py
```

**ç­›é€‰å‚æ•°**ï¼ˆå¯åœ¨è„šæœ¬ä¸­è°ƒæ•´ï¼‰ï¼š
```python
# ä¸šç»©æŒ‡æ ‡ç­›é€‰
min_ic=0.02                    # æœ€å°ICå€¼
min_annual_return=0.0          # æœ€å°å¹´åŒ–æ”¶ç›Š
max_drawdown=-0.3              # æœ€å¤§å›æ’¤é˜ˆå€¼

# å¤šæ ·æ€§ç­›é€‰
diversity_threshold=0.6        # å¤šæ ·æ€§æ¯”ä¾‹

# è´ªå¿ƒç®—æ³•
top_n=50                       # é€‰æ‹©å› å­æ•°é‡
max_correlation=0.8            # æœ€å¤§ICç›¸å…³æ€§
ic_weight=0.6                  # ICæƒé‡
return_weight=0.4              # æ”¶ç›Šæƒé‡

# èšç±»ç®—æ³•
n_clusters=10                  # èšç±»æ•°é‡
factors_per_cluster=5          # æ¯ç°‡å› å­æ•°
```

**è¾“å‡º**ï¼š
- `output/selected_factors_greedy.csv` - è´ªå¿ƒç®—æ³•ç»“æœ
- `output/selected_factors_cluster.csv` - èšç±»ç®—æ³•ç»“æœ
- `output/selected_factors_greedy.pkl` - å®Œæ•´æ•°æ®ï¼ˆæ¨èï¼‰

---

### æ­¥éª¤3ï¼šå›æµ‹éªŒè¯

```bash
python 03_backtest_validation.py
```

**åŠŸèƒ½**ï¼š
- å¯¼å‡ºé€‰å®šå› å­çš„æ•°æ®ä¸ºparquetæ ¼å¼
- ç”Ÿæˆqlibå›æµ‹é…ç½®æ–‡ä»¶
- æä¾›å›æµ‹æ‰§è¡Œå‘½ä»¤

**è¾“å‡º**ï¼š
- `output/backtest/combined_factors.parquet` - å› å­æ•°æ®
- `output/backtest/backtest_config.yaml` - qlibé…ç½®
- `output/backtest/factor_metadata.csv` - å› å­å…ƒæ•°æ®

**è¿è¡Œå›æµ‹**ï¼š
```bash
cd output/backtest
qrun backtest_config.yaml
```

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### å› å­ç±»å‹åˆ†ç±»

è„šæœ¬é€šè¿‡ASTåˆ†æè‡ªåŠ¨å°†å› å­åˆ†ä¸ºä»¥ä¸‹ç±»å‹ï¼š

| ç±»å‹ | ç‰¹å¾ | ç¤ºä¾‹ |
|------|------|------|
| `momentum` | rolling + mean/std | ç§»åŠ¨å¹³å‡ã€å¸ƒæ—å¸¦ |
| `volume` | åŒ…å«volumeå…³é”®å­— | æˆäº¤é‡ç›¸å…³ |
| `correlation` | åŒ…å«corrå‡½æ•° | ä»·æ ¼ç›¸å…³æ€§ |
| `rank_based` | åŒ…å«rankå‡½æ•° | æ’åºç±»å› å­ |
| `mixed` | æ··åˆç‰¹å¾ | å¤åˆå› å­ |

### ICç›¸å…³æ€§è®¡ç®—

```python
# æŒ‰æ—¶é—´åˆ‡ç‰‡è®¡ç®—å› å­é—´çš„ICç›¸å…³æ€§
for datetime in unique_dates:
    ic_corr = factor1.corr(factor2)
    
# å–å¹³å‡å€¼ä½œä¸ºæœ€ç»ˆç›¸å…³æ€§
final_corr = mean(ic_corr_series)
```

### è´ªå¿ƒé€‰æ‹©é€»è¾‘

1. è®¡ç®—ç»¼åˆè¯„åˆ†ï¼š`score = IC * 0.6 + annual_return * 0.4`
2. æŒ‰è¯„åˆ†é™åºæ’åˆ—
3. è¿­ä»£é€‰æ‹©ï¼š
   - é¦–ä¸ªå› å­ç›´æ¥åŠ å…¥
   - åç»­å› å­ï¼šæ£€æŸ¥ä¸å·²é€‰å› å­çš„ICç›¸å…³æ€§
   - ç›¸å…³æ€§<0.8åˆ™åŠ å…¥ï¼Œå¦åˆ™è·³è¿‡

---

## ğŸ”§ é«˜çº§å®šåˆ¶

### ä¿®æ”¹ç­›é€‰ç­–ç•¥

ç¼–è¾‘ `02_factor_selection_and_combination.py`ï¼š

```python
# è‡ªå®šä¹‰ä¸šç»©ç­›é€‰
filtered_df = selector.filter_by_metrics(
    min_ic=0.03,                # æé«˜ICé—¨æ§›
    min_annual_return=0.05,     # è¦æ±‚5%å¹´åŒ–æ”¶ç›Š
    max_drawdown=-0.25          # æ›´ä¸¥æ ¼çš„å›æ’¤é™åˆ¶
)

# è°ƒæ•´ç»„åˆå¤§å°
greedy_selected = optimizer.greedy_selection(
    top_n=30,                   # å‡å°‘åˆ°30ä¸ªå› å­
    max_correlation=0.7,        # é™ä½ç›¸å…³æ€§é˜ˆå€¼
    ic_weight=0.7,              # æ›´é‡è§†IC
    return_weight=0.3
)
```

### æ·»åŠ æ–°çš„ç­›é€‰ç»´åº¦

```python
def filter_by_sharpe_ratio(self, min_sharpe: float = 1.0):
    """åŸºäºå¤æ™®æ¯”ç‡ç­›é€‰"""
    if 'ICIR' in self.df.columns:
        return self.df[self.df['ICIR'] >= min_sharpe]
    return self.df
```

### å®ç°é—ä¼ ç®—æ³•

```python
from deap import base, creator, tools, algorithms

def genetic_algorithm_selection(factors_df, population_size=50, generations=100):
    """
    ä½¿ç”¨é—ä¼ ç®—æ³•ä¼˜åŒ–å› å­ç»„åˆ
    - ä¸ªä½“ï¼šå› å­ç»„åˆï¼ˆäºŒè¿›åˆ¶ç¼–ç ï¼‰
    - é€‚åº”åº¦ï¼šå›æµ‹å¤æ™®æ¯”ç‡
    - å˜å¼‚ï¼šéšæœºæ·»åŠ /åˆ é™¤å› å­
    - äº¤å‰ï¼šäº¤æ¢å› å­å­é›†
    """
    # TODO: å®ç°é—ä¼ ç®—æ³•
    pass
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

æ ¹æ®RD-Agentç°æœ‰æœºåˆ¶å’Œqlibç‰¹æ€§ï¼š

| æŒ‡æ ‡ | æœªç­›é€‰ | ç­›é€‰åï¼ˆè´ªå¿ƒï¼‰ | ç­›é€‰åï¼ˆèšç±»ï¼‰ |
|------|--------|----------------|----------------|
| å› å­æ•° | 300 | 50 | 50 |
| IC | ~0.03 | >0.04 | >0.035 |
| å¹´åŒ–æ”¶ç›Š | 10-15% | 18-25% | 15-22% |
| æœ€å¤§å›æ’¤ | -30% | -20% | -22% |
| è®­ç»ƒæ—¶é—´ | æ…¢ | ä¸­ç­‰ | ä¸­ç­‰ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®å®Œæ•´æ€§
- ç¡®ä¿`__session__` pickleæ–‡ä»¶åŒ…å«å®Œæ•´çš„å®éªŒå¯¹è±¡
- æŸäº›å› å­çš„`result.h5`å¯èƒ½ä¸å­˜åœ¨ï¼Œä¼šè¢«è‡ªåŠ¨è·³è¿‡

### 2. å†…å­˜å ç”¨
- 300ä¸ªå› å­çš„å®Œæ•´æ•°æ®é‡è¾ƒå¤§ï¼ˆ>2GBï¼‰
- å»ºè®®åˆ†æ‰¹å¤„ç†æˆ–å¢åŠ ç³»ç»Ÿå†…å­˜

### 3. qlibç¯å¢ƒ
- å›æµ‹éœ€è¦qlibç¯å¢ƒå’Œæ•°æ®
- ç¡®ä¿å·²åˆå§‹åŒ–qlibæ•°æ®ï¼š`python scripts/get_data.py qlib_data --target_dir ~/.qlib/qlib_data/cn_data --region cn`

### 4. ç›¸å…³æ€§é˜ˆå€¼
- é»˜è®¤0.995è¾ƒä¸ºå®½æ¾ï¼Œå¯è°ƒæ•´åˆ°0.9-0.95ä»¥æé«˜å¤šæ ·æ€§
- é˜ˆå€¼è¿‡ä½å¯èƒ½å¯¼è‡´æ‰€æœ‰å› å­è¢«è¿‡æ»¤

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ‰¾ä¸åˆ°sessionæ–‡ä»¶
```
FileNotFoundError: æœªæ‰¾åˆ°sessionæ–‡ä»¶
```
**è§£å†³**ï¼šæ£€æŸ¥logç›®å½•è·¯å¾„ï¼Œç¡®ä¿æœ‰`__session__/*.pkl`æ–‡ä»¶

### é—®é¢˜2ï¼šå› å­ä»£ç ä¸ºç©º
```
factor_type: parse_error
```
**è§£å†³**ï¼šæŸäº›å®éªŒå¯¹è±¡ç¼ºå°‘`sub_workspace_list`ï¼Œæ­£å¸¸ç°è±¡ï¼Œä¼šè¢«è‡ªåŠ¨è·³è¿‡

### é—®é¢˜3ï¼šICå…¨éƒ¨ä¸ºNaN
```
ä¸šç»©æŒ‡æ ‡ç­›é€‰: 300 -> 0 ä¸ªå› å­
```
**è§£å†³**ï¼šæ£€æŸ¥sessionä¸­çš„å®éªŒæ˜¯å¦åŒ…å«æœ‰æ•ˆçš„`result`å­—æ®µ

### é—®é¢˜4ï¼šå›æµ‹å¤±è´¥
```
qlib.errors.QlibError: No data found
```
**è§£å†³**ï¼š
1. æ£€æŸ¥qlibæ•°æ®æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–
2. ç¡®è®¤`backtest_config.yaml`ä¸­çš„æ—¥æœŸèŒƒå›´å’Œæ•°æ®è·¯å¾„

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [RD-Agentæ–‡æ¡£](https://github.com/microsoft/RD-Agent)
- [Qlibæ–‡æ¡£](https://qlib.readthedocs.io/)
- [å› å­é€‰æ‹©è®ºæ–‡](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3247865)

---

## ğŸ”„ åç»­æ”¹è¿›æ–¹å‘

1. **å®æ—¶å› å­è¯„ä¼°**ï¼šå¢é‡å¼æ·»åŠ æ–°SOTAå› å­
2. **åŠ¨æ€æƒé‡è°ƒæ•´**ï¼šæ ¹æ®å¸‚åœºçŠ¶æ€è°ƒæ•´å› å­æƒé‡
3. **é›†æˆå­¦ä¹ **ï¼šå¤šä¸ªå› å­ç»„åˆçš„stacking/boosting
4. **é£é™©å¹³ä»·**ï¼šåŸºäºå› å­åæ–¹å·®çŸ©é˜µçš„é£é™©å¹³è¡¡
5. **å› å­æ—¶æ•ˆæ€§åˆ†æ**ï¼šæ£€æµ‹å› å­è¡°å‡ï¼Œå®šæœŸæ›´æ–°

---

**åˆ›å»ºæ—¥æœŸ**ï¼š2026-02-02  
**ç‰ˆæœ¬**ï¼šv1.0  
**ç»´æŠ¤è€…**ï¼šRD-Agent Team
